#!/bin/bash

# MAUT PANEL PRO EDITION - THEME EDITOR
# Owner: @maut_coder
# Powered by MAUT CODER

# Configuration
PANEL_DIR="/opt/maut-panel"
CONFIG_DIR="$PANEL_DIR/config"
SCRIPT_DIR="$PANEL_DIR/scripts"
LOG_DIR="/var/log/maut-panel"
THEME_FILE="$CONFIG_DIR/maut-theme.conf"
THEME_BACKUP_DIR="$PANEL_DIR/backup/themes"
THEME_FILE="$CONFIG_DIR/maut-theme.conf"

# Load current theme
load_theme() {
    if [[ -f "$THEME_FILE" ]]; then
        source "$THEME_FILE"
    else
        # Default MAUT theme (red/black)
        THEME_NAME="maut_default"
        COLOR_PRIMARY='\033[0;31m'
        COLOR_SECONDARY='\033[0;33m'
        COLOR_ACCENT='\033[0;36m'
        COLOR_SUCCESS='\033[0;32m'
        COLOR_WARNING='\033[1;33m'
        COLOR_ERROR='\033[0;31m'
        COLOR_INFO='\033[0;34m'
        COLOR_RESET='\033[0m'
    fi
}

# Logging
log_theme() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - THEME: $1" >> "$LOG_DIR/maut-actions.log"
}

# Display current theme
show_current_theme() {
    load_theme
    
    echo -e "${COLOR_INFO}Current Theme: $THEME_NAME${COLOR_RESET}"
    echo "════════════════════════════════════════"
    echo ""
    
    echo -e "${COLOR_PRIMARY}Primary Color: MAUT Red${COLOR_RESET} (Used for headers and important elements)"
    echo -e "${COLOR_SECONDARY}Secondary Color: Gold/Yellow${COLOR_RESET} (Used for secondary elements)"
    echo -e "${COLOR_ACCENT}Accent Color: Cyan${COLOR_RESET} (Used for accents and highlights)"
    echo -e "${COLOR_SUCCESS}Success Color: Green${COLOR_RESET} (Used for success messages)"
    echo -e "${COLOR_WARNING}Warning Color: Yellow${COLOR_RESET} (Used for warnings)"
    echo -e "${COLOR_ERROR}Error Color: Red${COLOR_RESET} (Used for error messages)"
    echo -e "${COLOR_INFO}Info Color: Blue${COLOR_RESET} (Used for information messages)"
    echo ""
    
    # Show theme preview
    echo -e "${COLOR_INFO}Theme Preview:${COLOR_RESET}"
    echo -e "${COLOR_PRIMARY}████ Primary Color${COLOR_RESET}"
    echo -e "${COLOR_SECONDARY}████ Secondary Color${COLOR_RESET}"
    echo -e "${COLOR_ACCENT}████ Accent Color${COLOR_RESET}"
    echo -e "${COLOR_SUCCESS}████ Success Color${COLOR_RESET}"
    echo -e "${COLOR_WARNING}████ Warning Color${COLOR_RESET}"
    echo -e "${COLOR_ERROR}████ Error Color${COLOR_RESET}"
    echo -e "${COLOR_INFO}████ Info Color${COLOR_RESET}"
}

# Apply predefined theme
apply_predefined_theme() {
    echo -e "${COLOR_INFO}Apply Predefined Theme${COLOR_RESET}"
    echo ""
    
    echo "Available Themes:"
    echo "1. MAUT Default (Red/Black) - Professional"
    echo "2. Blue Ocean - Calm and Trustworthy"
    echo "3. Green Forest - Natural and Fresh"
    echo "4. Purple Royal - Premium and Luxury"
    echo "5. Orange Sunset - Warm and Energetic"
    echo "6. Cyber Neon - Modern and Tech"
    echo "7. Custom Theme (Manual Configuration)"
    echo "8. Back to Menu"
    
    read -p "Select theme (1-8): " choice
    
    case $choice in
        1)
            apply_maut_theme
            ;;
        2)
            apply_blue_theme
            ;;
        3)
            apply_green_theme
            ;;
        4)
            apply_purple_theme
            ;;
        5)
            apply_orange_theme
            ;;
        6)
            apply_cyber_theme
            ;;
        7)
            apply_custom_theme
            ;;
        8)
            return
            ;;
        *)
            echo -e "${COLOR_ERROR}Invalid selection${COLOR_RESET}"
            return 1
            ;;
    esac
    
    if [ $? -eq 0 ]; then
        echo -e "${COLOR_SUCCESS}Theme applied successfully!${COLOR_RESET}"
        echo -e "${COLOR_INFO}Changes will take effect in the next menu load.${COLOR_RESET}"
        log_theme "Applied theme: $THEME_NAME"
    fi
}

# MAUT Default Theme (Red/Black)
apply_maut_theme() {
    cat > "$THEME_FILE" << 'EOF'
THEME_NAME="maut_default"
COLOR_PRIMARY='\033[0;31m'
COLOR_SECONDARY='\033[0;33m'
COLOR_ACCENT='\033[0;36m'
COLOR_SUCCESS='\033[0;32m'
COLOR_WARNING='\033[1;33m'
COLOR_ERROR='\033[0;31m'
COLOR_INFO='\033[0;34m'
COLOR_RESET='\033[0m'
EOF
    echo -e "${COLOR_SUCCESS}MAUT Default Theme applied${COLOR_RESET}"
}

# Blue Ocean Theme
apply_blue_theme() {
    cat > "$THEME_FILE" << 'EOF'
THEME_NAME="blue_ocean"
COLOR_PRIMARY='\033[0;34m'
COLOR_SECONDARY='\033[0;36m'
COLOR_ACCENT='\033[0;94m'
COLOR_SUCCESS='\033[0;32m'
COLOR_WARNING='\033[1;33m'
COLOR_ERROR='\033[0;31m'
COLOR_INFO='\033[0;35m'
COLOR_RESET='\033[0m'
EOF
    echo -e "${COLOR_SUCCESS}Blue Ocean Theme applied${COLOR_RESET}"
}

# Green Forest Theme
apply_green_theme() {
    cat > "$THEME_FILE" << 'EOF'
THEME_NAME="green_forest"
COLOR_PRIMARY='\033[0;32m'
COLOR_SECONDARY='\033[0;36m'
COLOR_ACCENT='\033[0;92m'
COLOR_SUCCESS='\033[1;32m'
COLOR_WARNING='\033[1;33m'
COLOR_ERROR='\033[0;31m'
COLOR_INFO='\033[0;34m'
COLOR_RESET='\033[0m'
EOF
    echo -e "${COLOR_SUCCESS}Green Forest Theme applied${COLOR_RESET}"
}

# Purple Royal Theme
apply_purple_theme() {
    cat > "$THEME_FILE" << 'EOF'
THEME_NAME="purple_royal"
COLOR_PRIMARY='\033[0;35m'
COLOR_SECONDARY='\033[0;34m'
COLOR_ACCENT='\033[0;95m'
COLOR_SUCCESS='\033[0;32m'
COLOR_WARNING='\033[1;33m'
COLOR_ERROR='\033[0;31m'
COLOR_INFO='\033[0;36m'
COLOR_RESET='\033[0m'
EOF
    echo -e "${COLOR_SUCCESS}Purple Royal Theme applied${COLOR_RESET}"
}

# Orange Sunset Theme
apply_orange_theme() {
    cat > "$THEME_FILE" << 'EOF'
THEME_NAME="orange_sunset"
COLOR_PRIMARY='\033[0;33m'
COLOR_SECONDARY='\033[0;31m'
COLOR_ACCENT='\033[0;93m'
COLOR_SUCCESS='\033[0;32m'
COLOR_WARNING='\033[1;33m'
COLOR_ERROR='\033[0;31m'
COLOR_INFO='\033[0;34m'
COLOR_RESET='\033[0m'
EOF
    echo -e "${COLOR_SUCCESS}Orange Sunset Theme applied${COLOR_RESET}"
}

# Cyber Neon Theme
apply_cyber_theme() {
    cat > "$THEME_FILE" << 'EOF'
THEME_NAME="cyber_neon"
COLOR_PRIMARY='\033[0;36m'
COLOR_SECONDARY='\033[0;35m'
COLOR_ACCENT='\033[0;96m'
COLOR_SUCCESS='\033[0;32m'
COLOR_WARNING='\033[1;33m'
COLOR_ERROR='\033[0;31m'
COLOR_INFO='\033[0;34m'
COLOR_RESET='\033[0m'
EOF
    echo -e "${COLOR_SUCCESS}Cyber Neon Theme applied${COLOR_RESET}"
}

# Apply custom theme
apply_custom_theme() {
    echo -e "${COLOR_INFO}Custom Theme Configuration${COLOR_RESET}"
    echo ""
    echo -e "${COLOR_WARNING}Note: You need to know ANSI color codes for this option${COLOR_RESET}"
    echo ""
    
    read -p "Enter theme name: " theme_name
    if [[ -z "$theme_name" ]]; then
        echo -e "${COLOR_ERROR}Theme name cannot be empty${COLOR_RESET}"
        return 1
    fi
    
    echo ""
    echo -e "${COLOR_INFO}Available ANSI Color Codes:${COLOR_RESET}"
    echo "Black: \033[0;30m"
    echo "Red: \033[0;31m"
    echo "Green: \033[0;32m"
    echo "Yellow: \033[0;33m"
    echo "Blue: \033[0;34m"
    echo "Magenta: \033[0;35m"
    echo "Cyan: \033[0;36m"
    echo "White: \033[0;37m"
    echo "Bright Black: \033[1;30m"
    echo "Bright Red: \033[1;31m"
    echo "Bright Green: \033[1;32m"
    echo "Bright Yellow: \033[1;33m"
    echo "Bright Blue: \033[1;34m"
    echo "Bright Magenta: \033[1;35m"
    echo "Bright Cyan: \033[1;36m"
    echo "Bright White: \033[1;37m"
    echo ""
    
    echo "Enter color codes in the format: \\033[0;31m"
    echo ""
    
    read -p "Primary Color: " primary_color
    read -p "Secondary Color: " secondary_color
    read -p "Accent Color: " accent_color
    read -p "Success Color: " success_color
    read -p "Warning Color: " warning_color
    read -p "Error Color: " error_color
    read -p "Info Color: " info_color
    
    # Set default colors if empty
    primary_color=${primary_color:-'\033[0;31m'}
    secondary_color=${secondary_color:-'\033[0;33m'}
    accent_color=${accent_color:-'\033[0;36m'}
    success_color=${success_color:-'\033[0;32m'}
    warning_color=${warning_color:-'\033[1;33m'}
    error_color=${error_color:-'\033[0;31m'}
    info_color=${info_color:-'\033[0;34m'}
    
    cat > "$THEME_FILE" << EOF
THEME_NAME="$theme_name"
COLOR_PRIMARY='$primary_color'
COLOR_SECONDARY='$secondary_color'
COLOR_ACCENT='$accent_color'
COLOR_SUCCESS='$success_color'
COLOR_WARNING='$warning_color'
COLOR_ERROR='$error_color'
COLOR_INFO='$info_color'
COLOR_RESET='\033[0m'
EOF
    
    echo -e "${COLOR_SUCCESS}Custom theme '$theme_name' applied${COLOR_RESET}"
}

# Backup current theme
backup_theme() {
    echo -e "${COLOR_INFO}Backup Current Theme${COLOR_RESET}"
    echo ""
    
    mkdir -p "$THEME_BACKUP_DIR"
    
    local timestamp=$(date +%Y%m%d_%H%M%S)
    local backup_file="$THEME_BACKUP_DIR/theme_${timestamp}.conf"
    
    if [[ -f "$THEME_FILE" ]]; then
        cp "$THEME_FILE" "$backup_file"
        echo -e "${COLOR_SUCCESS}Theme backed up to: $backup_file${COLOR_RESET}"
        log_theme "Backed up theme to $backup_file"
    else
        echo -e "${COLOR_ERROR}No theme file found to backup${COLOR_RESET}"
    fi
}

# Restore theme from backup
restore_theme() {
    echo -e "${COLOR_INFO}Restore Theme from Backup${COLOR_RESET}"
    echo ""
    
    if [[ ! -d "$THEME_BACKUP_DIR" ]]; then
        echo -e "${COLOR_ERROR}No backup directory found${COLOR_RESET}"
        return 1
    fi
    
    local backups=($(ls -t "$THEME_BACKUP_DIR"/*.conf 2>/dev/null))
    
    if [[ ${#backups[@]} -eq 0 ]]; then
        echo -e "${COLOR_ERROR}No theme backups found${COLOR_RESET}"
        return 1
    fi
    
    echo -e "${COLOR_INFO}Available backups:${COLOR_RESET}"
    local i=1
    for backup in "${backups[@]}"; do
        local theme_name=$(grep "THEME_NAME" "$backup" 2>/dev/null | cut -d'"' -f2 || echo "Unknown")
        local date=$(stat -c %y "$backup" | cut -d' ' -f1)
        echo "$i. $theme_name ($date)"
        ((i++))
    done
    
    echo ""
    read -p "Select backup to restore (1-${#backups[@]}): " choice
    
    if [[ ! "$choice" =~ ^[0-9]+$ ]] || [ "$choice" -lt 1 ] || [ "$choice" -gt ${#backups[@]} ]; then
        echo -e "${COLOR_ERROR}Invalid selection${COLOR_RESET}"
        return 1
    fi
    
    local selected_backup="${backups[$((choice-1))]}"
    
    cp "$selected_backup" "$THEME_FILE"
    echo -e "${COLOR_SUCCESS}Theme restored from: $(basename "$selected_backup")${COLOR_RESET}"
    log_theme "Restored theme from $selected_backup"
}

# Reset to default theme
reset_default_theme() {
    echo -e "${COLOR_INFO}Reset to Default Theme${COLOR_RESET}"
    echo ""
    
    echo -e "${COLOR_WARNING}This will reset to MAUT Default Theme${COLOR_RESET}"
    read -p "Are you sure? (y/N): " confirm
    
    if [[ "$confirm" == "y" || "$confirm" == "Y" ]]; then
        apply_maut_theme
        echo -e "${COLOR_SUCCESS}Theme reset to MAUT Default${COLOR_RESET}"
        log_theme "Reset to default theme"
    else
        echo "Theme reset cancelled"
    fi
}

# Test theme colors
test_theme_colors() {
    load_theme
    
    echo -e "${COLOR_INFO}Theme Color Test${COLOR_RESET}"
    echo "════════════════════════════════════════"
    echo ""
    
    echo -e "${COLOR_PRIMARY}This is Primary Color - Used for headers and important elements${COLOR_RESET}"
    echo -e "${COLOR_SECONDARY}This is Secondary Color - Used for secondary elements${COLOR_RESET}"
    echo -e "${COLOR_ACCENT}This is Accent Color - Used for accents and highlights${COLOR_RESET}"
    echo -e "${COLOR_SUCCESS}This is Success Color - Used for success messages${COLOR_RESET}"
    echo -e "${COLOR_WARNING}This is Warning Color - Used for warnings${COLOR_RESET}"
    echo -e "${COLOR_ERROR}This is Error Color - Used for error messages${COLOR_RESET}"
    echo -e "${COLOR_INFO}This is Info Color - Used for information messages${COLOR_RESET}"
    echo ""
    
    # Show color blocks
    echo -e "${COLOR_INFO}Color Blocks Preview:${COLOR_RESET}"
    echo -e "${COLOR_PRIMARY}████████████████████${COLOR_RESET} Primary"
    echo -e "${COLOR_SECONDARY}████████████████████${COLOR_RESET} Secondary"
    echo -e "${COLOR_ACCENT}████████████████████${COLOR_RESET} Accent"
    echo -e "${COLOR_SUCCESS}████████████████████${COLOR_RESET} Success"
    echo -e "${COLOR_WARNING}████████████████████${COLOR_RESET} Warning"
    echo -e "${COLOR_ERROR}████████████████████${COLOR_RESET} Error"
    echo -e "${COLOR_INFO}████████████████████${COLOR_RESET} Info"
}

# Export theme
export_theme() {
    echo -e "${COLOR_INFO}Export Theme${COLOR_RESET}"
    echo ""
    
    if [[ ! -f "$THEME_FILE" ]]; then
        echo -e "${COLOR_ERROR}No theme file found${COLOR_RESET}"
        return 1
    fi
    
    local export_dir="$PANEL_DIR/exports"
    mkdir -p "$export_dir"
    
    local timestamp=$(date +%Y%m%d_%H%M%S)
    local export_file="$export_dir/maut_theme_${timestamp}.conf"
    
    cp "$THEME_FILE" "$export_file"
    
    echo -e "${COLOR_SUCCESS}Theme exported to: $export_file${COLOR_RESET}"
    echo -e "${COLOR_INFO}You can share this file or use it on other MAUT Panel installations.${COLOR_RESET}"
    
    log_theme "Exported theme to $export_file"
}

# Import theme
import_theme() {
    echo -e "${COLOR_INFO}Import Theme${COLOR_RESET}"
    echo ""
    
    echo -e "${COLOR_INFO}Please place your theme file in: $PANEL_DIR/exports/${COLOR_RESET}"
    echo -e "${COLOR_INFO}Or provide the full path to the theme file.${COLOR_RESET}"
    echo ""
    
    read -p "Enter theme file path: " theme_path
    
    if [[ -z "$theme_path" ]]; then
        echo -e "${COLOR_ERROR}Theme file path cannot be empty${COLOR_RESET}"
        return 1
    fi
    
    if [[ ! -f "$theme_path" ]]; then
        echo -e "${COLOR_ERROR}Theme file not found: $theme_path${COLOR_RESET}"
        return 1
    fi
    
    # Validate theme file
    if ! grep -q "COLOR_PRIMARY" "$theme_path"; then
        echo -e "${COLOR_ERROR}Invalid theme file format${COLOR_RESET}"
        return 1
    fi
    
    # Backup current theme
    backup_theme
    
    # Import new theme
    cp "$theme_path" "$THEME_FILE"
    
    echo -e "${COLOR_SUCCESS}Theme imported successfully!${COLOR_RESET}"
    log_theme "Imported theme from $theme_path"
}

# Theme menu
show_theme_menu() {
    clear
    load_theme
    
    echo -e "${COLOR_PRIMARY}"
    echo " ╔══════════════════════════════════════╗"
    echo " ║            THEME EDITOR             ║"
    echo " ║           MAUT PANEL PRO            ║"
    echo " ╚══════════════════════════════════════╝"
    echo -e "${COLOR_RESET}"
    echo -e "${COLOR_INFO}Customize the appearance of your MAUT Panel${COLOR_RESET}"
    echo "════════════════════════════════════════"
    echo ""
    
    # Show current theme
    echo -e "${COLOR_SUCCESS}Current Theme: $THEME_NAME${COLOR_RESET}"
    echo ""
    
    echo -e "${COLOR_PRIMARY}THEME MENU:${COLOR_RESET}"
    echo -e "${COLOR_SUCCESS}01${COLOR_RESET} Show Current Theme"
    echo -e "${COLOR_SUCCESS}02${COLOR_RESET} Apply Predefined Theme"
    echo -e "${COLOR_SUCCESS}03${COLOR_RESET} Test Theme Colors"
    echo -e "${COLOR_SUCCESS}04${COLOR_RESET} Backup Current Theme"
    echo -e "${COLOR_SUCCESS}05${COLOR_RESET} Restore Theme Backup"
    echo -e "${COLOR_SUCCESS}06${COLOR_RESET} Reset to Default"
    echo -e "${COLOR_SUCCESS}07${COLOR_RESET} Export Theme"
    echo -e "${COLOR_SUCCESS}08${COLOR_RESET} Import Theme"
    echo -e "${COLOR_SUCCESS}09${COLOR_RESET} Back to Main Menu"
    echo ""
}

# Main theme function
main() {
    load_theme
    
    while true; do
        show_theme_menu
        
        read -p "Enter your choice: " choice
        echo ""
        
        case $choice in
            01) show_current_theme ;;
            02) apply_predefined_theme ;;
            03) test_theme_colors ;;
            04) backup_theme ;;
            05) restore_theme ;;
            06) reset_default_theme ;;
            07) export_theme ;;
            08) import_theme ;;
            09) 
                log_theme "Exited Theme Editor"
                break 
                ;;
            *) 
                echo -e "${COLOR_ERROR}Invalid choice! Please try again.${COLOR_RESET}"
                ;;
        esac
        
        echo ""
        read -p "Press Enter to continue..."
    done
}

# Start main function
main "$@"