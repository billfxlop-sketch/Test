#!/bin/bash

# MAUT PANEL PRO EDITION - XRAY MANAGER
# Owner: @maut_coder
# Powered by MAUT CODER

# Configuration
PANEL_DIR="/opt/maut-panel"
CONFIG_DIR="$PANEL_DIR/config"
SCRIPT_DIR="$PANEL_DIR/scripts"
LOG_DIR="/var/log/maut-panel"
XRAY_CONFIG="/usr/local/etc/xray/config.json"
XRAY_LOG="/var/log/xray/access.log"
THEME_FILE="$CONFIG_DIR/maut-theme.conf"

# Load theme
load_theme() {
    if [[ -f "$THEME_FILE" ]]; then
        source "$THEME_FILE"
    else
        COLOR_PRIMARY='\033[0;31m'
        COLOR_SECONDARY='\033[0;33m'
        COLOR_ACCENT='\033[0;36m'
        COLOR_SUCCESS='\033[0;32m'
        COLOR_WARNING='\033[1;33m'
        COLOR_ERROR='\033[0;31m'
        COLOR_INFO='\033[0;34m'
        COLOR_RESET='\033[0m'
    fi
}

# Logging
log_action() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - XRAY: $1" >> "$LOG_DIR/maut-actions.log"
}

# Check Xray installation
check_xray_installation() {
    if ! command -v xray &> /dev/null; then
        echo -e "${COLOR_ERROR}Xray is not installed${COLOR_RESET}"
        return 1
    fi
    
    XRAY_VERSION=$(xray version | head -n1 | awk '{print $2}')
    echo -e "${COLOR_SUCCESS}Xray Version: $XRAY_VERSION${COLOR_RESET}"
    return 0
}

# Xray service control
xray_service_control() {
    echo -e "${COLOR_INFO}Xray Service Control${COLOR_RESET}"
    echo ""
    
    echo "1. Start Xray"
    echo "2. Stop Xray"
    echo "3. Restart Xray"
    echo "4. Reload Xray"
    echo "5. Check Status"
    echo "6. Enable Auto-start"
    echo "7. Disable Auto-start"
    echo "8. Back to Menu"
    
    read -p "Enter your choice: " choice
    
    case $choice in
        1)
            systemctl start xray
            echo -e "${COLOR_SUCCESS}Xray service started${COLOR_RESET}"
            ;;
        2)
            systemctl stop xray
            echo -e "${COLOR_WARNING}Xray service stopped${COLOR_RESET}"
            ;;
        3)
            systemctl restart xray
            echo -e "${COLOR_SUCCESS}Xray service restarted${COLOR_RESET}"
            ;;
        4)
            systemctl reload xray
            echo -e "${COLOR_SUCCESS}Xray configuration reloaded${COLOR_RESET}"
            ;;
        5)
            systemctl status xray --no-pager -l
            ;;
        6)
            systemctl enable xray
            echo -e "${COLOR_SUCCESS}Xray auto-start enabled${COLOR_RESET}"
            ;;
        7)
            systemctl disable xray
            echo -e "${COLOR_WARNING}Xray auto-start disabled${COLOR_RESET}"
            ;;
        8)
            return
            ;;
        *)
            echo -e "${COLOR_ERROR}Invalid choice${COLOR_RESET}"
            ;;
    esac
    
    log_action "Performed Xray service control: option $choice"
}

# Show Xray configuration
show_xray_config() {
    echo -e "${COLOR_INFO}Xray Configuration${COLOR_RESET}"
    echo ""
    
    if [[ ! -f "$XRAY_CONFIG" ]]; then
        echo -e "${COLOR_ERROR}Xray configuration file not found: $XRAY_CONFIG${COLOR_RESET}"
        return 1
    fi
    
    echo -e "${COLOR_INFO}Configuration file: $XRAY_CONFIG${COLOR_RESET}"
    echo ""
    
    # Show basic config info
    echo -e "${COLOR_SUCCESS}Inbounds:${COLOR_RESET}"
    if command -v jq >/dev/null 2>&1; then
        jq -r '.inbounds[] | "\(.protocol) on port \(.port) (\(.tag // "no tag"))"' "$XRAY_CONFIG" 2>/dev/null || echo "Unable to parse JSON"
    else
        grep -E '"protocol"|"port"' "$XRAY_CONFIG" | head -10
    fi
    
    echo ""
    echo -e "${COLOR_SUCCESS}Outbounds:${COLOR_RESET}"
    if command -v jq >/dev/null 2>&1; then
        jq -r '.outbounds[] | "\(.protocol) (\(.tag // "no tag"))"' "$XRAY_CONFIG" 2>/dev/null || echo "Unable to parse JSON"
    else
        grep -E '"protocol"|"tag"' "$XRAY_CONFIG" | grep -A1 '"outbounds"' | head -10
    fi
}

# Check Xray configuration
check_xray_config() {
    echo -e "${COLOR_INFO}Checking Xray Configuration${COLOR_RESET}"
    echo ""
    
    if [[ ! -f "$XRAY_CONFIG" ]]; then
        echo -e "${COLOR_ERROR}Configuration file not found${COLOR_RESET}"
        return 1
    fi
    
    # Test configuration with xray
    if xray -test -config "$XRAY_CONFIG" &>/dev/null; then
        echo -e "${COLOR_SUCCESS}✓ Configuration is valid${COLOR_RESET}"
    else
        echo -e "${COLOR_ERROR}✗ Configuration contains errors${COLOR_RESET}"
        xray -test -config "$XRAY_CONFIG" 2>&1 | head -10
        return 1
    fi
    
    # Check if required directories exist
    echo ""
    echo -e "${COLOR_INFO}Directory Checks:${COLOR_RESET}"
    local log_dir=$(jq -r '.log.logDirectory // "/var/log/xray"' "$XRAY_CONFIG" 2>/dev/null || echo "/var/log/xray")
    
    if [[ -d "$log_dir" ]]; then
        echo -e "${COLOR_SUCCESS}✓ Log directory exists: $log_dir${COLOR_RESET}"
    else
        echo -e "${COLOR_WARNING}⚠ Log directory missing: $log_dir${COLOR_RESET}"
    fi
    
    # Check SSL certificates if mentioned in config
    if grep -q "certificateFile" "$XRAY_CONFIG"; then
        echo ""
        echo -e "${COLOR_INFO}SSL Certificate Checks:${COLOR_RESET}"
        local cert_files=$(grep -o '"certificateFile": *"[^"]*"' "$XRAY_CONFIG" | cut -d'"' -f4)
        for cert in $cert_files; do
            if [[ -f "$cert" ]]; then
                echo -e "${COLOR_SUCCESS}✓ Certificate exists: $cert${COLOR_RESET}"
            else
                echo -e "${COLOR_ERROR}✗ Certificate missing: $cert${COLOR_RESET}"
            fi
        done
    fi
}

# View Xray logs
view_xray_logs() {
    echo -e "${COLOR_INFO}Xray Logs${COLOR_RESET}"
    echo ""
    
    if [[ ! -f "$XRAY_LOG" ]]; then
        echo -e "${COLOR_WARNING}Xray log file not found: $XRAY_LOG${COLOR_RESET}"
        echo "Checking for alternative log locations..."
        
        # Try to find log file from config
        if [[ -f "$XRAY_CONFIG" ]] && command -v jq >/dev/null 2>&1; then
            local log_path=$(jq -r '.log.access // "/var/log/xray/access.log"' "$XRAY_CONFIG" 2>/dev/null)
            if [[ -f "$log_path" ]]; then
                XRAY_LOG="$log_path"
                echo -e "${COLOR_INFO}Found log file: $XRAY_LOG${COLOR_RESET}"
            fi
        fi
    fi
    
    if [[ -f "$XRAY_LOG" ]]; then
        echo "1. View last 50 lines"
        echo "2. View last 100 lines"
        echo "3. View real-time logs"
        echo "4. Search in logs"
        echo "5. Clear logs"
        echo "6. Back to Menu"
        
        read -p "Enter your choice: " choice
        
        case $choice in
            1)
                tail -50 "$XRAY_LOG"
                ;;
            2)
                tail -100 "$XRAY_LOG"
                ;;
            3)
                echo -e "${COLOR_WARNING}Press Ctrl+C to stop real-time viewing${COLOR_RESET}"
                tail -f "$XRAY_LOG"
                ;;
            4)
                read -p "Enter search term: " search_term
                grep "$search_term" "$XRAY_LOG" | tail -50
                ;;
            5)
                echo -n "" > "$XRAY_LOG"
                echo -e "${COLOR_SUCCESS}Logs cleared${COLOR_RESET}"
                ;;
            6)
                return
                ;;
            *)
                echo -e "${COLOR_ERROR}Invalid choice${COLOR_RESET}"
                ;;
        esac
    else
        echo -e "${COLOR_ERROR}No Xray log file found${COLOR_RESET}"
        echo -e "${COLOR_INFO}Current Xray service status:${COLOR_RESET}"
        systemctl status xray --no-pager -l | head -20
    fi
}

# Xray statistics
show_xray_stats() {
    echo -e "${COLOR_INFO}Xray Statistics${COLOR_RESET}"
    echo ""
    
    # Show service status
    echo -e "${COLOR_SUCCESS}Service Status:${COLOR_RESET}"
    systemctl is-active xray && echo -e "${COLOR_SUCCESS}Active${COLOR_RESET}" || echo -e "${COLOR_ERROR}Inactive${COLOR_RESET}"
    
    # Show uptime
    echo -e "${COLOR_SUCCESS}Uptime:${COLOR_RESET}"
    systemctl status xray --no-pager | grep -o "Active:.*" | cut -d';' -f2 | xargs
    
    # Show memory usage
    echo -e "${COLOR_SUCCESS}Memory Usage:${COLOR_RESET}"
    local xray_pid=$(pgrep xray)
    if [[ -n "$xray_pid" ]]; then
        ps -o pid,ppid,cmd,%mem,%cpu --sort=-%mem | head -6
    else
        echo "Xray process not found"
    fi
    
    # Show network connections
    echo ""
    echo -e "${COLOR_SUCCESS}Network Connections:${COLOR_RESET}"
    netstat -tulpn | grep xray || echo "No Xray connections found"
    
    # Show recent log entries count
    if [[ -f "$XRAY_LOG" ]]; then
        echo ""
        echo -e "${COLOR_SUCCESS}Recent Activity:${COLOR_RESET}"
        local recent_count=$(tail -1000 "$XRAY_LOG" | wc -l)
        echo "Last 1000 log entries: $recent_count"
        
        # Count by type if log has specific patterns
        local accepted_count=$(grep -c "accepted" "$XRAY_LOG" 2>/dev/null || echo "0")
        local rejected_count=$(grep -c "rejected" "$XRAY_LOG" 2>/dev/null || echo "0")
        echo "Accepted connections: $accepted_count"
        echo "Rejected connections: $rejected_count"
    fi
}

# Backup Xray configuration
backup_xray_config() {
    echo -e "${COLOR_INFO}Backup Xray Configuration${COLOR_RESET}"
    echo ""
    
    local backup_dir="/opt/maut-panel/backup/xray"
    local timestamp=$(date +%Y%m%d_%H%M%S)
    local backup_file="$backup_dir/xray_config_$timestamp.json"
    
    mkdir -p "$backup_dir"
    
    if [[ -f "$XRAY_CONFIG" ]]; then
        cp "$XRAY_CONFIG" "$backup_file"
        if [ $? -eq 0 ]; then
            echo -e "${COLOR_SUCCESS}Configuration backed up to: $backup_file${COLOR_RESET}"
            log_action "Backed up Xray configuration"
            
            # List recent backups
            echo ""
            echo -e "${COLOR_INFO}Recent backups:${COLOR_RESET}"
            ls -lt "$backup_dir" | head -5
        else
            echo -e "${COLOR_ERROR}Failed to create backup${COLOR_RESET}"
        fi
    else
        echo -e "${COLOR_ERROR}Xray configuration file not found${COLOR_RESET}"
    fi
}

# Restore Xray configuration
restore_xray_config() {
    echo -e "${COLOR_INFO}Restore Xray Configuration${COLOR_RESET}"
    echo ""
    
    local backup_dir="/opt/maut-panel/backup/xray"
    
    if [[ ! -d "$backup_dir" ]]; then
        echo -e "${COLOR_ERROR}Backup directory not found${COLOR_RESET}"
        return 1
    fi
    
    local backups=($(ls -t "$backup_dir"/*.json 2>/dev/null))
    
    if [[ ${#backups[@]} -eq 0 ]]; then
        echo -e "${COLOR_ERROR}No backup files found${COLOR_RESET}"
        return 1
    fi
    
    echo -e "${COLOR_INFO}Available backups:${COLOR_RESET}"
    local i=1
    for backup in "${backups[@]}"; do
        echo "$i. $(basename "$backup")"
        ((i++))
    done
    
    read -p "Select backup to restore (1-${#backups[@]}): " choice
    
    if [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -ge 1 ] && [ "$choice" -le ${#backups[@]} ]; then
        local selected_backup="${backups[$((choice-1))]}"
        
        # Create restore backup
        local restore_backup="$backup_dir/restore_backup_$(date +%Y%m%d_%H%M%S).json"
        cp "$XRAY_CONFIG" "$restore_backup" 2>/dev/null
        
        # Restore selected backup
        cp "$selected_backup" "$XRAY_CONFIG"
        
        # Test configuration
        if xray -test -config "$XRAY_CONFIG" &>/dev/null; then
            echo -e "${COLOR_SUCCESS}✓ Configuration restored and validated${COLOR_RESET}"
            echo -e "${COLOR_WARNING}Restarting Xray service...${COLOR_RESET}"
            systemctl restart xray
            log_action "Restored Xray configuration from: $(basename "$selected_backup")"
        else
            echo -e "${COLOR_ERROR}✗ Restored configuration contains errors${COLOR_RESET}"
            echo -e "${COLOR_INFO}Restoring original configuration...${COLOR_RESET}"
            cp "$restore_backup" "$XRAY_CONFIG"
            return 1
        fi
    else
        echo -e "${COLOR_ERROR}Invalid selection${COLOR_RESET}"
    fi
}

# Update Xray core
update_xray_core() {
    echo -e "${COLOR_INFO}Update Xray Core${COLOR_RESET}"
    echo ""
    
    echo -e "${COLOR_WARNING}This will update Xray to the latest version${COLOR_RESET}"
    echo -e "${COLOR_WARNING}Make sure to backup your configuration first!${COLOR_RESET}"
    echo ""
    
    read -p "Are you sure you want to continue? (y/N): " confirm
    
    if [[ "$confirm" != "y" && "$confirm" != "Y" ]]; then
        echo "Update cancelled"
        return
    fi
    
    # Backup current configuration
    backup_xray_config
    
    # Update Xray using official script
    echo -e "${COLOR_INFO}Updating Xray...${COLOR_RESET}"
    bash -c "$(curl -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)" @ install
    
    if [ $? -eq 0 ]; then
        echo -e "${COLOR_SUCCESS}Xray updated successfully${COLOR_RESET}"
        log_action "Updated Xray core"
        
        # Show new version
        local new_version=$(xray version | head -n1 | awk '{print $2}')
        echo -e "${COLOR_INFO}New version: $new_version${COLOR_RESET}"
        
        # Restart service
        systemctl restart xray
        echo -e "${COLOR_SUCCESS}Xray service restarted${COLOR_RESET}"
    else
        echo -e "${COLOR_ERROR}Xray update failed${COLOR_RESET}"
    fi
}

# Xray menu
show_xray_menu() {
    clear
    echo -e "${COLOR_PRIMARY}"
    echo " ╔══════════════════════════════════════╗"
    echo " ║            XRAY MANAGER             ║"
    echo " ║           MAUT PANEL PRO            ║"
    echo " ╚══════════════════════════════════════╝"
    echo -e "${COLOR_RESET}"
    echo -e "${COLOR_INFO}Manage Xray core and configurations${COLOR_RESET}"
    echo "════════════════════════════════════════"
    echo ""
    
    # Show Xray status
    check_xray_installation
    echo ""
    
    echo -e "${COLOR_PRIMARY}XRAY MENU:${COLOR_RESET}"
    echo -e "${COLOR_SUCCESS}01${COLOR_RESET} Service Control"
    echo -e "${COLOR_SUCCESS}02${COLOR_RESET} Show Configuration"
    echo -e "${COLOR_SUCCESS}03${COLOR_RESET} Check Configuration"
    echo -e "${COLOR_SUCCESS}04${COLOR_RESET} View Logs"
    echo -e "${COLOR_SUCCESS}05${COLOR_RESET} Statistics"
    echo -e "${COLOR_SUCCESS}06${COLOR_RESET} Backup Config"
    echo -e "${COLOR_SUCCESS}07${COLOR_RESET} Restore Config"
    echo -e "${COLOR_SUCCESS}08${COLOR_RESET} Update Xray Core"
    echo -e "${COLOR_SUCCESS}09${COLOR_RESET} Back to Main Menu"
    echo ""
}

# Main Xray function
main() {
    load_theme
    
    while true; do
        show_xray_menu
        
        read -p "Enter your choice: " choice
        echo ""
        
        case $choice in
            01) xray_service_control ;;
            02) show_xray_config ;;
            03) check_xray_config ;;
            04) view_xray_logs ;;
            05) show_xray_stats ;;
            06) backup_xray_config ;;
            07) restore_xray_config ;;
            08) update_xray_core ;;
            09) 
                log_action "Exited Xray Manager"
                break 
                ;;
            *) 
                echo -e "${COLOR_ERROR}Invalid choice! Please try again.${COLOR_RESET}"
                ;;
        esac
        
        echo ""
        read -p "Press Enter to continue..."
    done
}

# Start main function
main "$@" 