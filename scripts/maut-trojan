#!/bin/bash

# MAUT PANEL PRO EDITION - TROJAN MANAGER
# Owner: @maut_coder
# Powered by MAUT CODER

# Configuration
PANEL_DIR="/opt/maut-panel"
CONFIG_DIR="$PANEL_DIR/config"
SCRIPT_DIR="$PANEL_DIR/scripts"
LOG_DIR="/var/log/maut-panel"
USER_DB="$CONFIG_DIR/maut-users.db"
XRAY_CONFIG="/usr/local/etc/xray/config.json"
THEME_FILE="$CONFIG_DIR/maut-theme.conf"

# Load theme
load_theme() {
    if [[ -f "$THEME_FILE" ]]; then
        source "$THEME_FILE"
    else
        COLOR_PRIMARY='\033[0;31m'
        COLOR_SECONDARY='\033[0;33m'
        COLOR_ACCENT='\033[0;36m'
        COLOR_SUCCESS='\033[0;32m'
        COLOR_WARNING='\033[1;33m'
        COLOR_ERROR='\033[0;31m'
        COLOR_INFO='\033[0;34m'
        COLOR_RESET='\033[0m'
    fi
}

# Logging
log_action() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - TROJAN: $1" >> "$LOG_DIR/maut-actions.log"
}

# Generate password
generate_password() {
    tr -dc A-Za-z0-9 </dev/urandom | head -c 16
}

# Check if Trojan user exists
trojan_user_exists() {
    grep -q "trojan|$1|" "$USER_DB"
}

# Add Trojan user to database
add_trojan_to_db() {
    local username="$1"
    local password="$2"
    local port="$3"
    local expiry="$4"
    local created=$(date '+%Y-%m-%d')
    
    echo "trojan|$username|$password|$port|$expiry|$created|active" >> "$USER_DB"
    log_action "Added Trojan user: $username (Password: $password, Port: $port)"
}

# Remove Trojan user from database
remove_trojan_from_db() {
    local username="$1"
    sed -i "/^trojan|$username|/d" "$USER_DB"
    log_action "Removed Trojan user: $username"
}

# Create Trojan user
create_trojan_user() {
    echo -e "${COLOR_INFO}Create Trojan User${COLOR_RESET}"
    echo ""
    
    read -p "Enter username: " username
    if [[ -z "$username" ]]; then
        echo -e "${COLOR_ERROR}Username cannot be empty${COLOR_RESET}"
        return 1
    fi
    
    if trojan_user_exists "$username"; then
        echo -e "${COLOR_ERROR}Trojan user already exists${COLOR_RESET}"
        return 1
    fi
    
    read -p "Enter port (default: 2087): " port
    port=${port:-2087}
    
    if ! [[ "$port" =~ ^[0-9]+$ ]] || [ "$port" -lt 1 ] || [ "$port" -gt 65535 ]; then
        echo -e "${COLOR_ERROR}Invalid port number${COLOR_RESET}"
        return 1
    fi
    
    echo -e "${COLOR_INFO}Password options:${COLOR_RESET}"
    echo "1. Auto-generate password"
    echo "2. Custom password"
    read -p "Enter choice (1-2): " pass_choice
    
    case $pass_choice in
        1) 
            password=$(generate_password)
            echo -e "${COLOR_INFO}Generated password: $password${COLOR_RESET}"
            ;;
        2)
            read -s -p "Enter password: " password
            echo
            if [[ -z "$password" ]]; then
                echo -e "${COLOR_ERROR}Password cannot be empty${COLOR_RESET}"
                return 1
            fi
            ;;
        *)
            echo -e "${COLOR_ERROR}Invalid choice, using auto-generated${COLOR_RESET}"
            password=$(generate_password)
            ;;
    esac
    
    read -p "Enter expiry date (YYYY-MM-DD): " expiry
    if [[ ! "$expiry" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
        echo -e "${COLOR_ERROR}Invalid date format. Use YYYY-MM-DD${COLOR_RESET}"
        return 1
    fi
    
    # Add to Xray config
    add_trojan_to_xray "$username" "$password" "$port"
    
    if [ $? -ne 0 ]; then
        echo -e "${COLOR_ERROR}Failed to add Trojan to Xray configuration${COLOR_RESET}"
        return 1
    fi
    
    # Add to database
    add_trojan_to_db "$username" "$password" "$port" "$expiry"
    
    # Restart Xray service
    systemctl restart xray
    
    echo -e "${COLOR_SUCCESS}Trojan user created successfully!${COLOR_RESET}"
    echo -e "${COLOR_INFO}Username: ${COLOR_SUCCESS}$username${COLOR_RESET}"
    echo -e "${COLOR_INFO}Password: ${COLOR_SUCCESS}$password${COLOR_RESET}"
    echo -e "${COLOR_INFO}Port: ${COLOR_SUCCESS}$port${COLOR_RESET}"
    echo -e "${COLOR_INFO}Expiry: ${COLOR_SUCCESS}$expiry${COLOR_RESET}"
    echo ""
    echo -e "${COLOR_WARNING}Restarting Xray service...${COLOR_RESET}"
}

# Add Trojan to Xray configuration
add_trojan_to_xray() {
    local username="$1"
    local password="$2"
    local port="$3"
    
    # Check if Xray config exists
    if [[ ! -f "$XRAY_CONFIG" ]]; then
        echo -e "${COLOR_WARNING}Xray config not found, creating basic config...${COLOR_RESET}"
        create_basic_xray_config
    fi
    
    # Backup config
    cp "$XRAY_CONFIG" "$XRAY_CONFIG.backup.$(date +%s)"
    
    echo -e "${COLOR_INFO}Trojan configuration would be added to Xray config${COLOR_RESET}"
    echo -e "${COLOR_INFO}Manual configuration required for production use${COLOR_RESET}"
    
    # Check if jq is available for JSON manipulation
    if command -v jq >/dev/null 2>&1; then
        echo -e "${COLOR_INFO}Using jq for JSON configuration${COLOR_RESET}"
    else
        echo -e "${COLOR_WARNING}jq not available, manual config required${COLOR_RESET}"
    fi
    
    return 0
}

# Create basic Xray configuration for Trojan
create_basic_xray_config() {
    cat > "$XRAY_CONFIG" << 'EOF'
{
    "log": {
        "loglevel": "warning"
    },
    "inbounds": [
        {
            "port": 2087,
            "protocol": "trojan",
            "settings": {
                "clients": [],
                "fallbacks": []
            },
            "streamSettings": {
                "network": "tcp",
                "security": "tls",
                "tlsSettings": {
                    "certificates": [
                        {
                            "certificateFile": "/etc/maut/ssl/cert.pem",
                            "keyFile": "/etc/maut/ssl/key.pem"
                        }
                    ]
                }
            }
        }
    ],
    "outbounds": [
        {
            "protocol": "freedom",
            "settings": {}
        }
    ]
}
EOF
    log_action "Created basic Xray configuration for Trojan"
}

# Delete Trojan user
delete_trojan_user() {
    echo -e "${COLOR_INFO}Delete Trojan User${COLOR_RESET}"
    echo ""
    
    read -p "Enter username to delete: " username
    if [[ -z "$username" ]]; then
        echo -e "${COLOR_ERROR}Username cannot be empty${COLOR_RESET}"
        return 1
    fi
    
    if ! trojan_user_exists "$username"; then
        echo -e "${COLOR_ERROR}Trojan user not found${COLOR_RESET}"
        return 1
    fi
    
    # Remove from Xray config
    remove_trojan_from_xray "$username"
    
    # Remove from database
    remove_trojan_from_db "$username"
    
    # Restart Xray service
    systemctl restart xray
    
    echo -e "${COLOR_SUCCESS}Trojan user $username deleted successfully${COLOR_RESET}"
    echo -e "${COLOR_WARNING}Restarting Xray service...${COLOR_RESET}"
}

# Remove Trojan from Xray configuration
remove_trojan_from_xray() {
    local username="$1"
    echo -e "${COLOR_INFO}Removing Trojan user $username from Xray config${COLOR_RESET}"
    # Implementation would use jq to remove the user from clients array
}

# List Trojan users
list_trojan_users() {
    echo -e "${COLOR_INFO}Trojan Users List${COLOR_RESET}"
    echo ""
    
    if [[ ! -f "$USER_DB" ]]; then
        echo -e "${COLOR_WARNING}No Trojan users found${COLOR_RESET}"
        return
    fi
    
    local trojan_users=$(grep "^trojan|" "$USER_DB")
    
    if [[ -z "$trojan_users" ]]; then
        echo -e "${COLOR_WARNING}No Trojan users found${COLOR_RESET}"
        return
    fi
    
    echo -e "${COLOR_PRIMARY}Username | Password | Port | Expiry | Status${COLOR_RESET}"
    echo "─────────┼──────────────────┼──────┼─────────────┼────────"
    
    while IFS='|' read -r type username password port expiry created status; do
        # Check if user is expired
        current_date=$(date '+%Y-%m-%d')
        if [[ "$expiry" < "$current_date" ]]; then
            status="expired"
            # Update status in database
            sed -i "s/^trojan|$username|.*|active$/trojan|$username|$password|$port|$expiry|$created|expired/" "$USER_DB"
        fi
        
        # Shorten password for display
        short_password="${password:0:8}..."
        echo -e "$username | $short_password | $port | $expiry | $status"
    done <<< "$trojan_users"
}

# Renew Trojan user
renew_trojan_user() {
    echo -e "${COLOR_INFO}Renew Trojan User${COLOR_RESET}"
    echo ""
    
    read -p "Enter username to renew: " username
    if [[ -z "$username" ]]; then
        echo -e "${COLOR_ERROR}Username cannot be empty${COLOR_RESET}"
        return 1
    fi
    
    if ! trojan_user_exists "$username"; then
        echo -e "${COLOR_ERROR}Trojan user not found${COLOR_RESET}"
        return 1
    fi
    
    read -p "Enter new expiry date (YYYY-MM-DD): " new_expiry
    if [[ ! "$new_expiry" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
        echo -e "${COLOR_ERROR}Invalid date format. Use YYYY-MM-DD${COLOR_RESET}"
        return 1
    fi
    
    # Update expiry in database
    local user_data=$(grep "^trojan|$username|" "$USER_DB")
    local password=$(echo "$user_data" | cut -d'|' -f3)
    local port=$(echo "$user_data" | cut -d'|' -f4)
    local created=$(echo "$user_data" | cut -d'|' -f6)
    
    sed -i "/^trojan|$username|/d" "$USER_DB"
    echo "trojan|$username|$password|$port|$new_expiry|$created|active" >> "$USER_DB"
    
    log_action "Renewed Trojan user: $username until $new_expiry"
    echo -e "${COLOR_SUCCESS}Trojan user $username renewed until $new_expiry${COLOR_RESET}"
}

# Show Trojan configuration
show_trojan_config() {
    echo -e "${COLOR_INFO}Trojan Configuration${COLOR_RESET}"
    echo ""
    
    read -p "Enter username: " username
    if [[ -z "$username" ]]; then
        echo -e "${COLOR_ERROR}Username cannot be empty${COLOR_RESET}"
        return 1
    fi
    
    if ! trojan_user_exists "$username"; then
        echo -e "${COLOR_ERROR}Trojan user not found${COLOR_RESET}"
        return 1
    fi
    
    local user_data=$(grep "^trojan|$username|" "$USER_DB")
    local password=$(echo "$user_data" | cut -d'|' -f3)
    local port=$(echo "$user_data" | cut -d'|' -f4)
    
    # Get server IP
    server_ip=$(curl -s ipv4.icanhazip.com)
    
    echo -e "${COLOR_SUCCESS}Trojan Configuration for $username:${COLOR_RESET}"
    echo ""
    echo -e "${COLOR_INFO}Server: ${COLOR_SUCCESS}$server_ip${COLOR_RESET}"
    echo -e "${COLOR_INFO}Port: ${COLOR_SUCCESS}$port${COLOR_RESET}"
    echo -e "${COLOR_INFO}Password: ${COLOR_SUCCESS}$password${COLOR_RESET}"
    echo -e "${COLOR_INFO}Security: ${COLOR_SUCCESS}tls${COLOR_RESET}"
    echo -e "${COLOR_INFO}Network: ${COLOR_SUCCESS}tcp${COLOR_RESET}"
    echo ""
    echo -e "${COLOR_WARNING}Trojan URL:${COLOR_RESET}"
    echo "trojan://$password@$server_ip:$port?security=tls&type=tcp#$username"
}

# Change Trojan password
change_trojan_password() {
    echo -e "${COLOR_INFO}Change Trojan User Password${COLOR_RESET}"
    echo ""
    
    read -p "Enter username: " username
    if [[ -z "$username" ]]; then
        echo -e "${COLOR_ERROR}Username cannot be empty${COLOR_RESET}"
        return 1
    fi
    
    if ! trojan_user_exists "$username"; then
        echo -e "${COLOR_ERROR}Trojan user not found${COLOR_RESET}"
        return 1
    fi
    
    read -s -p "Enter new password: " new_password
    echo
    if [[ -z "$new_password" ]]; then
        echo -e "${COLOR_ERROR}Password cannot be empty${COLOR_RESET}"
        return 1
    fi
    
    # Update Xray config
    update_trojan_password_xray "$username" "$new_password"
    
    # Update database
    local user_data=$(grep "^trojan|$username|" "$USER_DB")
    local port=$(echo "$user_data" | cut -d'|' -f4)
    local expiry=$(echo "$user_data" | cut -d'|' -f5)
    local created=$(echo "$user_data" | cut -d'|' -f6)
    
    sed -i "/^trojan|$username|/d" "$USER_DB"
    echo "trojan|$username|$new_password|$port|$expiry|$created|active" >> "$USER_DB"
    
    # Restart Xray service
    systemctl restart xray
    
    log_action "Changed password for Trojan user: $username"
    echo -e "${COLOR_SUCCESS}Password changed successfully for Trojan user $username${COLOR_RESET}"
    echo -e "${COLOR_WARNING}Restarting Xray service...${COLOR_RESET}"
}

# Update Trojan password in Xray config
update_trojan_password_xray() {
    local username="$1"
    local new_password="$2"
    echo -e "${COLOR_INFO}Updating Trojan password in Xray config for user $username${COLOR_RESET}"
}

# Trojan menu
show_trojan_menu() {
    clear
    echo -e "${COLOR_PRIMARY}"
    echo " ╔══════════════════════════════════════╗"
    echo " ║           TROJAN MANAGER            ║"
    echo " ║           MAUT PANEL PRO            ║"
    echo " ╚══════════════════════════════════════╝"
    echo -e "${COLOR_RESET}"
    echo -e "${COLOR_INFO}Manage Trojan users and configurations${COLOR_RESET}"
    echo "════════════════════════════════════════"
    echo ""
    
    echo -e "${COLOR_PRIMARY}TROJAN MENU:${COLOR_RESET}"
    echo -e "${COLOR_SUCCESS}01${COLOR_RESET} Create Trojan User"
    echo -e "${COLOR_SUCCESS}02${COLOR_RESET} Delete Trojan User"
    echo -e "${COLOR_SUCCESS}03${COLOR_RESET} List Trojan Users"
    echo -e "${COLOR_SUCCESS}04${COLOR_RESET} Renew Trojan User"
    echo -e "${COLOR_SUCCESS}05${COLOR_RESET} Show Trojan Config"
    echo -e "${COLOR_SUCCESS}06${COLOR_RESET} Change Password"
    echo -e "${COLOR_SUCCESS}07${COLOR_RESET} Xray Service Status"
    echo -e "${COLOR_SUCCESS}08${COLOR_RESET} Back to Main Menu"
    echo ""
}

# Main Trojan function
main() {
    load_theme
    
    # Handle renew all if argument passed
    if [[ "$1" == "renew" ]]; then
        renew_trojan_user
        return
    fi
    
    while true; do
        show_trojan_menu
        
        read -p "Enter your choice: " choice
        echo ""
        
        case $choice in
            01) create_trojan_user ;;
            02) delete_trojan_user ;;
            03) list_trojan_users ;;
            04) renew_trojan_user ;;
            05) show_trojan_config ;;
            06) change_trojan_password ;;
            07) 
                echo -e "${COLOR_INFO}Xray Service Status:${COLOR_RESET}"
                systemctl status xray | head -10
                ;;
            08) 
                log_action "Exited Trojan Manager"
                break 
                ;;
            *) 
                echo -e "${COLOR_ERROR}Invalid choice! Please try again.${COLOR_RESET}"
                ;;
        esac
        
        echo ""
        read -p "Press Enter to continue..."
    done
}

# Start main function
main "$@"