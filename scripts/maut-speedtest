#!/bin/bash

# MAUT PANEL PRO EDITION - SPEEDTEST MANAGER
# Owner: @maut_coder
# Powered by MAUT CODER

# Configuration
PANEL_DIR="/opt/maut-panel"
CONFIG_DIR="$PANEL_DIR/config"
SCRIPT_DIR="$PANEL_DIR/scripts"
LOG_DIR="/var/log/maut-panel"
SPEEDTEST_LOG="$LOG_DIR/maut-speedtest.log"
THEME_FILE="$CONFIG_DIR/maut-theme.conf"

# Load theme
load_theme() {
    if [[ -f "$THEME_FILE" ]]; then
        source "$THEME_FILE"
    else
        COLOR_PRIMARY='\033[0;31m'
        COLOR_SECONDARY='\033[0;33m'
        COLOR_ACCENT='\033[0;36m'
        COLOR_SUCCESS='\033[0;32m'
        COLOR_WARNING='\033[1;33m'
        COLOR_ERROR='\033[0;31m'
        COLOR_INFO='\033[0;34m'
        COLOR_RESET='\033[0m'
    fi
}

# Logging
log_speedtest() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - SPEEDTEST: $1" >> "$SPEEDTEST_LOG"
}

# Check if speedtest is installed
check_speedtest_installed() {
    if command -v speedtest &> /dev/null; then
        return 0
    elif command -v speedtest-cli &> /dev/null; then
        return 0
    else
        return 1
    fi
}

# Install speedtest
install_speedtest() {
    echo -e "${COLOR_INFO}Installing Speedtest...${COLOR_RESET}"
    echo ""
    
    if command -v apt-get &> /dev/null; then
        apt-get update
        apt-get install -y speedtest-cli
    elif command -v yum &> /dev/null; then
        yum install -y speedtest-cli
    else
        echo -e "${COLOR_ERROR}Could not determine package manager${COLOR_RESET}"
        return 1
    fi
    
    if check_speedtest_installed; then
        echo -e "${COLOR_SUCCESS}Speedtest installed successfully${COLOR_RESET}"
        return 0
    else
        echo -e "${COLOR_ERROR}Failed to install speedtest${COLOR_RESET}"
        return 1
    fi
}

# Run basic speedtest
run_basic_speedtest() {
    echo -e "${COLOR_INFO}Running Basic Speedtest...${COLOR_RESET}"
    echo -e "${COLOR_WARNING}This may take a few moments...${COLOR_RESET}"
    echo ""
    
    if ! check_speedtest_installed; then
        echo -e "${COLOR_ERROR}Speedtest is not installed${COLOR_RESET}"
        read -p "Would you like to install it now? (y/N): " install_choice
        if [[ "$install_choice" == "y" || "$install_choice" == "Y" ]]; then
            install_speedtest
            if [ $? -ne 0 ]; then
                return 1
            fi
        else
            return 1
        fi
    fi
    
    # Determine which speedtest command to use
    local speedtest_cmd="speedtest"
    if ! command -v speedtest &> /dev/null; then
        speedtest_cmd="speedtest-cli"
    fi
    
    echo -e "${COLOR_INFO}Testing download and upload speeds...${COLOR_RESET}"
    echo ""
    
    # Run speedtest with simple output
    $speedtest_cmd --simple
    
    if [ $? -eq 0 ]; then
        log_speedtest "Basic speedtest completed"
    else
        echo -e "${COLOR_ERROR}Speedtest failed${COLOR_RESET}"
        log_speedtest "Basic speedtest failed"
    fi
}

# Run detailed speedtest
run_detailed_speedtest() {
    echo -e "${COLOR_INFO}Running Detailed Speedtest...${COLOR_RESET}"
    echo -e "${COLOR_WARNING}This may take 1-2 minutes...${COLOR_RESET}"
    echo ""
    
    if ! check_speedtest_installed; then
        echo -e "${COLOR_ERROR}Speedtest is not installed${COLOR_RESET}"
        return 1
    fi
    
    # Determine which speedtest command to use
    local speedtest_cmd="speedtest"
    if ! command -v speedtest &> /dev/null; then
        speedtest_cmd="speedtest-cli"
    fi
    
    echo -e "${COLOR_INFO}Testing with detailed information...${COLOR_RESET}"
    echo ""
    
    # Run detailed speedtest
    $speedtest_cmd
    
    if [ $? -eq 0 ]; then
        log_speedtest "Detailed speedtest completed"
    else
        echo -e "${COLOR_ERROR}Detailed speedtest failed${COLOR_RESET}"
        log_speedtest "Detailed speedtest failed"
    fi
}

# Run speedtest to specific server
run_specific_server_test() {
    echo -e "${COLOR_INFO}Speedtest to Specific Server${COLOR_RESET}"
    echo ""
    
    if ! check_speedtest_installed; then
        echo -e "${COLOR_ERROR}Speedtest is not installed${COLOR_RESET}"
        return 1
    fi
    
    # Determine which speedtest command to use
    local speedtest_cmd="speedtest"
    if ! command -v speedtest &> /dev/null; then
        speedtest_cmd="speedtest-cli"
    fi
    
    # List available servers
    echo -e "${COLOR_INFO}Fetching available servers...${COLOR_RESET}"
    $speedtest_cmd --list | head -20
    
    echo ""
    read -p "Enter server ID to test against: " server_id
    
    if [[ -z "$server_id" ]] || ! [[ "$server_id" =~ ^[0-9]+$ ]]; then
        echo -e "${COLOR_ERROR}Invalid server ID${COLOR_RESET}"
        return 1
    fi
    
    echo -e "${COLOR_INFO}Testing against server $server_id...${COLOR_RESET}"
    echo ""
    
    $speedtest_cmd --server "$server_id" --simple
    
    if [ $? -eq 0 ]; then
        log_speedtest "Speedtest to server $server_id completed"
    else
        echo -e "${COLOR_ERROR}Speedtest to server $server_id failed${COLOR_RESET}"
        log_speedtest "Speedtest to server $server_id failed"
    fi
}

# Run multiple speedtests
run_multiple_tests() {
    echo -e "${COLOR_INFO}Multiple Speed Tests${COLOR_RESET}"
    echo ""
    
    read -p "Enter number of tests to run (default: 3): " test_count
    test_count=${test_count:-3}
    
    if ! [[ "$test_count" =~ ^[0-9]+$ ]] || [ "$test_count" -lt 1 ]; then
        echo -e "${COLOR_ERROR}Invalid number of tests${COLOR_RESET}"
        return 1
    fi
    
    if ! check_speedtest_installed; then
        echo -e "${COLOR_ERROR}Speedtest is not installed${COLOR_RESET}"
        return 1
    fi
    
    # Determine which speedtest command to use
    local speedtest_cmd="speedtest"
    if ! command -v speedtest &> /dev/null; then
        speedtest_cmd="speedtest-cli"
    fi
    
    echo -e "${COLOR_INFO}Running $test_count speed tests...${COLOR_RESET}"
    echo ""
    
    for ((i=1; i<=test_count; i++)); do
        echo -e "${COLOR_SUCCESS}Test $i of $test_count:${COLOR_RESET}"
        $speedtest_cmd --simple
        echo "────────────────────"
    done
    
    log_speedtest "Completed $test_count speed tests"
}

# Network latency test
run_latency_test() {
    echo -e "${COLOR_INFO}Network Latency Test${COLOR_RESET}"
    echo ""
    
    echo -e "${COLOR_INFO}Testing latency to various hosts...${COLOR_RESET}"
    echo ""
    
    local hosts=("8.8.8.8" "1.1.1.1" "google.com" "cloudflare.com")
    
    for host in "${hosts[@]}"; do
        echo -n "Testing $host... "
        
        # Ping test with 4 packets
        local result=$(ping -c 4 -W 2 "$host" 2>/dev/null | grep -oP 'avg.*?=\s*\K[\d.]+' | head -1)
        
        if [[ -n "$result" ]]; then
            echo -e "${COLOR_SUCCESS}${result}ms${COLOR_RESET}"
        else
            echo -e "${COLOR_ERROR}Failed${COLOR_RESET}"
        fi
    done
    
    echo ""
    echo -e "${COLOR_INFO}Traceroute to Google DNS...${COLOR_RESET}"
    traceroute -m 5 8.8.8.8 2>/dev/null | head -10
    
    log_speedtest "Latency test completed"
}

# Bandwidth usage monitoring
show_bandwidth_usage() {
    echo -e "${COLOR_INFO}Bandwidth Usage Monitoring${COLOR_RESET}"
    echo ""
    
    # Check if iftop is available
    if command -v iftop &> /dev/null; then
        echo -e "${COLOR_INFO}Real-time bandwidth usage (iftop)${COLOR_RESET}"
        echo -e "${COLOR_WARNING}Press Ctrl+C to stop monitoring${COLOR_RESET}"
        echo ""
        iftop -t -s 30
    else
        echo -e "${COLOR_WARNING}iftop not installed. Showing basic interface statistics...${COLOR_RESET}"
        echo ""
        
        # Show basic interface statistics
        echo -e "${COLOR_SUCCESS}Network Interface Statistics:${COLOR_RESET}"
        cat /proc/net/dev | grep -v lo | head -5
        
        echo ""
        echo -e "${COLOR_INFO}To install iftop:${COLOR_RESET}"
        echo "Ubuntu/Debian: apt-get install iftop"
        echo "CentOS/RHEL: yum install iftop"
    fi
    
    log_speedtest "Bandwidth usage checked"
}

# Internet connection test
test_internet_connection() {
    echo -e "${COLOR_INFO}Internet Connection Test${COLOR_RESET}"
    echo ""
    
    local test_hosts=(
        "Google DNS:8.8.8.8"
        "Cloudflare DNS:1.1.1.1" 
        "Google:google.com"
        "Cloudflare:cloudflare.com"
    )
    
    echo -e "${COLOR_SUCCESS}Testing connectivity to various services:${COLOR_RESET}"
    echo ""
    
    local all_success=true
    
    for host_entry in "${test_hosts[@]}"; do
        local name="${host_entry%:*}"
        local host="${host_entry#*:}"
        
        echo -n "Testing $name ($host)... "
        
        if ping -c 2 -W 1 "$host" &>/dev/null; then
            echo -e "${COLOR_SUCCESS}✓ Reachable${COLOR_RESET}"
        else
            echo -e "${COLOR_ERROR}✗ Unreachable${COLOR_RESET}"
            all_success=false
        fi
    done
    
    echo ""
    
    # Test HTTP/HTTPS connectivity
    echo -e "${COLOR_SUCCESS}Testing HTTP/HTTPS connectivity:${COLOR_RESET}"
    echo ""
    
    local http_test_hosts=("http://google.com" "https://google.com" "http://cloudflare.com" "https://cloudflare.com")
    
    for url in "${http_test_hosts[@]}"; do
        echo -n "Testing $url... "
        
        if curl -s --head --connect-timeout 5 "$url" | head -1 | grep -q "HTTP"; then
            echo -e "${COLOR_SUCCESS}✓ Accessible${COLOR_RESET}"
        else
            echo -e "${COLOR_ERROR}✗ Not accessible${COLOR_RESET}"
            all_success=false
        fi
    done
    
    echo ""
    
    if $all_success; then
        echo -e "${COLOR_SUCCESS}✓ All connectivity tests passed${COLOR_RESET}"
    else
        echo -e "${COLOR_WARNING}⚠ Some connectivity tests failed${COLOR_RESET}"
    fi
    
    log_speedtest "Internet connection test completed"
}

# View speedtest history
view_speedtest_history() {
    echo -e "${COLOR_INFO}Speedtest History${COLOR_RESET}"
    echo ""
    
    if [[ -f "$SPEEDTEST_LOG" ]]; then
        echo "1. View last 10 tests"
        echo "2. View last 20 tests"
        echo "3. View all tests"
        echo "4. Clear history"
        echo "5. Back to menu"
        
        read -p "Enter your choice: " choice
        
        case $choice in
            1)
                grep -E "SPEEDTEST:.*(completed|failed)" "$SPEEDTEST_LOG" | tail -10
                ;;
            2)
                grep -E "SPEEDTEST:.*(completed|failed)" "$SPEEDTEST_LOG" | tail -20
                ;;
            3)
                grep -E "SPEEDTEST:.*(completed|failed)" "$SPEEDTEST_LOG"
                ;;
            4)
                echo -n "" > "$SPEEDTEST_LOG"
                echo -e "${COLOR_SUCCESS}Speedtest history cleared${COLOR_RESET}"
                ;;
            5)
                return
                ;;
            *)
                echo -e "${COLOR_ERROR}Invalid choice${COLOR_RESET}"
                ;;
        esac
    else
        echo -e "${COLOR_WARNING}No speedtest history found${COLOR_RESET}"
    fi
}

# Speedtest comparison
compare_speedtests() {
    echo -e "${COLOR_INFO}Speedtest Comparison${COLOR_RESET}"
    echo ""
    
    if ! check_speedtest_installed; then
        echo -e "${COLOR_ERROR}Speedtest is not installed${COLOR_RESET}"
        return 1
    fi
    
    echo -e "${COLOR_INFO}Running tests to different servers for comparison...${COLOR_RESET}"
    echo ""
    
    # Determine which speedtest command to use
    local speedtest_cmd="speedtest"
    if ! command -v speedtest &> /dev/null; then
        speedtest_cmd="speedtest-cli"
    fi
    
    # Test to different server types
    local servers=(
        "Auto (Closest):"
        "Google:"
        "Cloudflare:"
    )
    
    # Get server lists
    local server_list=$($speedtest_cmd --list 2>/dev/null)
    
    # Auto server (closest)
    echo -e "${COLOR_SUCCESS}1. Testing to closest server:${COLOR_RESET}"
    $speedtest_cmd --simple
    echo ""
    
    # Try to find specific providers
    local google_server=$(echo "$server_list" | grep -i google | head -1 | awk '{print $1}' | tr -d ')')
    local cloudflare_server=$(echo "$server_list" | grep -i cloudflare | head -1 | awk '{print $1}' | tr -d ')')
    
    if [[ -n "$google_server" ]]; then
        echo -e "${COLOR_SUCCESS}2. Testing to Google server ($google_server):${COLOR_RESET}"
        $speedtest_cmd --server "$google_server" --simple
        echo ""
    fi
    
    if [[ -n "$cloudflare_server" ]]; then
        echo -e "${COLOR_SUCCESS}3. Testing to Cloudflare server ($cloudflare_server):${COLOR_RESET}"
        $speedtest_cmd --server "$cloudflare_server" --simple
        echo ""
    fi
    
    log_speedtest "Speedtest comparison completed"
}

# Speedtest menu
show_speedtest_menu() {
    clear
    echo -e "${COLOR_PRIMARY}"
    echo " ╔══════════════════════════════════════╗"
    echo " ║            SPEEDTEST MANAGER        ║"
    echo " ║           MAUT PANEL PRO            ║"
    echo " ╚══════════════════════════════════════╝"
    echo -e "${COLOR_RESET}"
    echo -e "${COLOR_INFO}Test network speed and connectivity${COLOR_RESET}"
    echo "════════════════════════════════════════"
    echo ""
    
    # Check if speedtest is installed
    if check_speedtest_installed; then
        echo -e "${COLOR_SUCCESS}✓ Speedtest is installed${COLOR_RESET}"
    else
        echo -e "${COLOR_WARNING}⚠ Speedtest is not installed${COLOR_RESET}"
    fi
    
    echo ""
    
    echo -e "${COLOR_PRIMARY}SPEEDTEST MENU:${COLOR_RESET}"
    echo -e "${COLOR_SUCCESS}01${COLOR_RESET} Basic Speedtest"
    echo -e "${COLOR_SUCCESS}02${COLOR_RESET} Detailed Speedtest"
    echo -e "${COLOR_SUCCESS}03${COLOR_RESET} Test Specific Server"
    echo -e "${COLOR_SUCCESS}04${COLOR_RESET} Multiple Tests"
    echo -e "${COLOR_SUCCESS}05${COLOR_RESET} Network Latency Test"
    echo -e "${COLOR_SUCCESS}06${COLOR_RESET} Bandwidth Usage"
    echo -e "${COLOR_SUCCESS}07${COLOR_RESET} Internet Connection Test"
    echo -e "${COLOR_SUCCESS}08${COLOR_RESET} View Test History"
    echo -e "${COLOR_SUCCESS}09${COLOR_RESET} Speedtest Comparison"
    echo -e "${COLOR_SUCCESS}10${COLOR_RESET} Install Speedtest"
    echo -e "${COLOR_SUCCESS}11${COLOR_RESET} Back to Main Menu"
    echo ""
}

# Main speedtest function
main() {
    load_theme
    
    while true; do
        show_speedtest_menu
        
        read -p "Enter your choice: " choice
        echo ""
        
        case $choice in
            01) run_basic_speedtest ;;
            02) run_detailed_speedtest ;;
            03) run_specific_server_test ;;
            04) run_multiple_tests ;;
            05) run_latency_test ;;
            06) show_bandwidth_usage ;;
            07) test_internet_connection ;;
            08) view_speedtest_history ;;
            09) compare_speedtests ;;
            10) install_speedtest ;;
            11) 
                log_speedtest "Exited Speedtest Manager"
                break 
                ;;
            *) 
                echo -e "${COLOR_ERROR}Invalid choice! Please try again.${COLOR_RESET}"
                ;;
        esac
        
        echo ""
        read -p "Press Enter to continue..."
    done
}

# Start main function
main "$@"