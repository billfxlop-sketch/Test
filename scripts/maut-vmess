#!/bin/bash

# MAUT PANEL PRO EDITION - VMESS MANAGER
# Owner: @maut_coder
# Powered by MAUT CODER

# Configuration
PANEL_DIR="/opt/maut-panel"
CONFIG_DIR="$PANEL_DIR/config"
SCRIPT_DIR="$PANEL_DIR/scripts"
LOG_DIR="/var/log/maut-panel"
USER_DB="$CONFIG_DIR/maut-users.db"
XRAY_CONFIG="/usr/local/etc/xray/config.json"
THEME_FILE="$CONFIG_DIR/maut-theme.conf"

# Load theme
load_theme() {
    if [[ -f "$THEME_FILE" ]]; then
        source "$THEME_FILE"
    else
        COLOR_PRIMARY='\033[0;31m'
        COLOR_SECONDARY='\033[0;33m'
        COLOR_ACCENT='\033[0;36m'
        COLOR_SUCCESS='\033[0;32m'
        COLOR_WARNING='\033[1;33m'
        COLOR_ERROR='\033[0;31m'
        COLOR_INFO='\033[0;34m'
        COLOR_RESET='\033[0m'
    fi
}

# Logging
log_action() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - VMESS: $1" >> "$LOG_DIR/maut-actions.log"
}

# Generate UUID
generate_uuid() {
    cat /proc/sys/kernel/random/uuid
}

# Check if VMESS user exists
vmess_user_exists() {
    grep -q "vmess|$1|" "$USER_DB"
}

# Add VMESS user to database
add_vmess_to_db() {
    local username="$1"
    local uuid="$2"
    local port="$3"
    local expiry="$4"
    local created=$(date '+%Y-%m-%d')
    
    echo "vmess|$username|$uuid|$port|$expiry|$created|active" >> "$USER_DB"
    log_action "Added VMESS user: $username (UUID: $uuid, Port: $port)"
}

# Remove VMESS user from database
remove_vmess_from_db() {
    local username="$1"
    sed -i "/^vmess|$username|/d" "$USER_DB"
    log_action "Removed VMESS user: $username"
}

# Create VMESS user
create_vmess_user() {
    echo -e "${COLOR_INFO}Create VMESS User${COLOR_RESET}"
    echo ""
    
    read -p "Enter username: " username
    if [[ -z "$username" ]]; then
        echo -e "${COLOR_ERROR}Username cannot be empty${COLOR_RESET}"
        return 1
    fi
    
    if vmess_user_exists "$username"; then
        echo -e "${COLOR_ERROR}VMESS user already exists${COLOR_RESET}"
        return 1
    fi
    
    read -p "Enter port (default: 8443): " port
    port=${port:-8443}
    
    if ! [[ "$port" =~ ^[0-9]+$ ]] || [ "$port" -lt 1 ] || [ "$port" -gt 65535 ]; then
        echo -e "${COLOR_ERROR}Invalid port number${COLOR_RESET}"
        return 1
    fi
    
    read -p "Enter expiry date (YYYY-MM-DD): " expiry
    if [[ ! "$expiry" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
        echo -e "${COLOR_ERROR}Invalid date format. Use YYYY-MM-DD${COLOR_RESET}"
        return 1
    fi
    
    # Generate UUID
    uuid=$(generate_uuid)
    
    # Add to Xray config (this is simplified - in production would need proper JSON manipulation)
    add_vmess_to_xray "$username" "$uuid" "$port"
    
    if [ $? -ne 0 ]; then
        echo -e "${COLOR_ERROR}Failed to add VMESS to Xray configuration${COLOR_RESET}"
        return 1
    fi
    
    # Add to database
    add_vmess_to_db "$username" "$uuid" "$port" "$expiry"
    
    # Restart Xray service
    systemctl restart xray
    
    echo -e "${COLOR_SUCCESS}VMESS user created successfully!${COLOR_RESET}"
    echo -e "${COLOR_INFO}Username: ${COLOR_SUCCESS}$username${COLOR_RESET}"
    echo -e "${COLOR_INFO}UUID: ${COLOR_SUCCESS}$uuid${COLOR_RESET}"
    echo -e "${COLOR_INFO}Port: ${COLOR_SUCCESS}$port${COLOR_RESET}"
    echo -e "${COLOR_INFO}Expiry: ${COLOR_SUCCESS}$expiry${COLOR_RESET}"
    echo ""
    echo -e "${COLOR_WARNING}Restarting Xray service...${COLOR_RESET}"
}

# Add VMESS to Xray configuration (simplified version)
add_vmess_to_xray() {
    local username="$1"
    local uuid="$2"
    local port="$3"
    
    # This is a simplified implementation
    # In production, you would use jq to properly manipulate the JSON config
    
    # Check if Xray config exists
    if [[ ! -f "$XRAY_CONFIG" ]]; then
        echo -e "${COLOR_WARNING}Xray config not found, creating basic config...${COLOR_RESET}"
        create_basic_xray_config
    fi
    
    # Backup config
    cp "$XRAY_CONFIG" "$XRAY_CONFIG.backup.$(date +%s)"
    
    echo -e "${COLOR_INFO}VMESS configuration would be added to Xray config${COLOR_RESET}"
    echo -e "${COLOR_INFO}Manual configuration required for production use${COLOR_RESET}"
    
    return 0
}

# Create basic Xray configuration
create_basic_xray_config() {
    cat > "$XRAY_CONFIG" << 'EOF'
{
    "log": {
        "loglevel": "warning"
    },
    "inbounds": [
        {
            "port": 8443,
            "protocol": "vmess",
            "settings": {
                "clients": []
            },
            "streamSettings": {
                "network": "tcp"
            }
        }
    ],
    "outbounds": [
        {
            "protocol": "freedom",
            "settings": {}
        }
    ]
}
EOF
    log_action "Created basic Xray configuration"
}

# Delete VMESS user
delete_vmess_user() {
    echo -e "${COLOR_INFO}Delete VMESS User${COLOR_RESET}"
    echo ""
    
    read -p "Enter username to delete: " username
    if [[ -z "$username" ]]; then
        echo -e "${COLOR_ERROR}Username cannot be empty${COLOR_RESET}"
        return 1
    fi
    
    if ! vmess_user_exists "$username"; then
        echo -e "${COLOR_ERROR}VMESS user not found${COLOR_RESET}"
        return 1
    fi
    
    # Remove from Xray config (simplified)
    remove_vmess_from_xray "$username"
    
    # Remove from database
    remove_vmess_from_db "$username"
    
    # Restart Xray service
    systemctl restart xray
    
    echo -e "${COLOR_SUCCESS}VMESS user $username deleted successfully${COLOR_RESET}"
    echo -e "${COLOR_WARNING}Restarting Xray service...${COLOR_RESET}"
}

# Remove VMESS from Xray configuration (simplified)
remove_vmess_from_xray() {
    local username="$1"
    echo -e "${COLOR_INFO}Removing VMESS user $username from Xray config${COLOR_RESET}"
    # Implementation would use jq to remove the user from clients array
}

# List VMESS users
list_vmess_users() {
    echo -e "${COLOR_INFO}VMESS Users List${COLOR_RESET}"
    echo ""
    
    if [[ ! -f "$USER_DB" ]]; then
        echo -e "${COLOR_WARNING}No VMESS users found${COLOR_RESET}"
        return
    fi
    
    local vmess_users=$(grep "^vmess|" "$USER_DB")
    
    if [[ -z "$vmess_users" ]]; then
        echo -e "${COLOR_WARNING}No VMESS users found${COLOR_RESET}"
        return
    fi
    
    echo -e "${COLOR_PRIMARY}Username | UUID | Port | Expiry | Status${COLOR_RESET}"
    echo "─────────┼─────────────────────┼──────┼─────────────┼────────"
    
    while IFS='|' read -r type username uuid port expiry created status; do
        # Check if user is expired
        current_date=$(date '+%Y-%m-%d')
        if [[ "$expiry" < "$current_date" ]]; then
            status="expired"
            # Update status in database
            sed -i "s/^vmess|$username|.*|active$/vmess|$username|$uuid|$port|$expiry|$created|expired/" "$USER_DB"
        fi
        
        # Shorten UUID for display
        short_uuid="${uuid:0:8}...${uuid: -8}"
        echo -e "$username | $short_uuid | $port | $expiry | $status"
    done <<< "$vmess_users"
}

# Renew VMESS user
renew_vmess_user() {
    echo -e "${COLOR_INFO}Renew VMESS User${COLOR_RESET}"
    echo ""
    
    read -p "Enter username to renew: " username
    if [[ -z "$username" ]]; then
        echo -e "${COLOR_ERROR}Username cannot be empty${COLOR_RESET}"
        return 1
    fi
    
    if ! vmess_user_exists "$username"; then
        echo -e "${COLOR_ERROR}VMESS user not found${COLOR_RESET}"
        return 1
    fi
    
    read -p "Enter new expiry date (YYYY-MM-DD): " new_expiry
    if [[ ! "$new_expiry" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
        echo -e "${COLOR_ERROR}Invalid date format. Use YYYY-MM-DD${COLOR_RESET}"
        return 1
    fi
    
    # Update expiry in database
    local user_data=$(grep "^vmess|$username|" "$USER_DB")
    local uuid=$(echo "$user_data" | cut -d'|' -f3)
    local port=$(echo "$user_data" | cut -d'|' -f4)
    local created=$(echo "$user_data" | cut -d'|' -f6)
    
    sed -i "/^vmess|$username|/d" "$USER_DB"
    echo "vmess|$username|$uuid|$port|$new_expiry|$created|active" >> "$USER_DB"
    
    log_action "Renewed VMESS user: $username until $new_expiry"
    echo -e "${COLOR_SUCCESS}VMESS user $username renewed until $new_expiry${COLOR_RESET}"
}

# Show VMESS configuration
show_vmess_config() {
    echo -e "${COLOR_INFO}VMESS Configuration${COLOR_RESET}"
    echo ""
    
    read -p "Enter username: " username
    if [[ -z "$username" ]]; then
        echo -e "${COLOR_ERROR}Username cannot be empty${COLOR_RESET}"
        return 1
    fi
    
    if ! vmess_user_exists "$username"; then
        echo -e "${COLOR_ERROR}VMESS user not found${COLOR_RESET}"
        return 1
    fi
    
    local user_data=$(grep "^vmess|$username|" "$USER_DB")
    local uuid=$(echo "$user_data" | cut -d'|' -f3)
    local port=$(echo "$user_data" | cut -d'|' -f4)
    
    # Get server IP
    server_ip=$(curl -s ipv4.icanhazip.com)
    
    echo -e "${COLOR_SUCCESS}VMESS Configuration for $username:${COLOR_RESET}"
    echo ""
    echo -e "${COLOR_INFO}Server: ${COLOR_SUCCESS}$server_ip${COLOR_RESET}"
    echo -e "${COLOR_INFO}Port: ${COLOR_SUCCESS}$port${COLOR_RESET}"
    echo -e "${COLOR_INFO}UUID: ${COLOR_SUCCESS}$uuid${COLOR_RESET}"
    echo -e "${COLOR_INFO}Security: ${COLOR_SUCCESS}auto${COLOR_RESET}"
    echo -e "${COLOR_INFO}Network: ${COLOR_SUCCESS}tcp${COLOR_RESET}"
    echo ""
    echo -e "${COLOR_WARNING}VMESS URL:${COLOR_RESET}"
    echo "vmess://$(echo '{"add":"'$server_ip'","aid":"0","host":"","id":"'$uuid'","net":"tcp","path":"","port":"'$port'","ps":"MAUT_'"$username"'","scy":"auto","sni":"","tls":"","type":"none","v":"2"}' | base64 -w 0)"
}

# VMESS menu
show_vmess_menu() {
    clear
    echo -e "${COLOR_PRIMARY}"
    echo " ╔══════════════════════════════════════╗"
    echo " ║           VMESS MANAGER             ║"
    echo " ║           MAUT PANEL PRO            ║"
    echo " ╚══════════════════════════════════════╝"
    echo -e "${COLOR_RESET}"
    echo -e "${COLOR_INFO}Manage VMESS users and configurations${COLOR_RESET}"
    echo "════════════════════════════════════════"
    echo ""
    
    echo -e "${COLOR_PRIMARY}VMESS MENU:${COLOR_RESET}"
    echo -e "${COLOR_SUCCESS}01${COLOR_RESET} Create VMESS User"
    echo -e "${COLOR_SUCCESS}02${COLOR_RESET} Delete VMESS User"
    echo -e "${COLOR_SUCCESS}03${COLOR_RESET} List VMESS Users"
    echo -e "${COLOR_SUCCESS}04${COLOR_RESET} Renew VMESS User"
    echo -e "${COLOR_SUCCESS}05${COLOR_RESET} Show VMESS Config"
    echo -e "${COLOR_SUCCESS}06${COLOR_RESET} Xray Service Status"
    echo -e "${COLOR_SUCCESS}07${COLOR_RESET} Back to Main Menu"
    echo ""
}

# Main VMESS function
main() {
    load_theme
    
    # Handle renew all if argument passed
    if [[ "$1" == "renew" ]]; then
        renew_vmess_user
        return
    fi
    
    while true; do
        show_vmess_menu
        
        read -p "Enter your choice: " choice
        echo ""
        
        case $choice in
            01) create_vmess_user ;;
            02) delete_vmess_user ;;
            03) list_vmess_users ;;
            04) renew_vmess_user ;;
            05) show_vmess_config ;;
            06) 
                echo -e "${COLOR_INFO}Xray Service Status:${COLOR_RESET}"
                systemctl status xray | head -10
                ;;
            07) 
                log_action "Exited VMESS Manager"
                break 
                ;;
            *) 
                echo -e "${COLOR_ERROR}Invalid choice! Please try again.${COLOR_RESET}"
                ;;
        esac
        
        echo ""
        read -p "Press Enter to continue..."
    done
}

# Start main function
main "$@"