#!/bin/bash

# MAUT PANEL PRO EDITION - USER ACTIVITY MONITOR
# Owner: @maut_coder
# Powered by MAUT CODER

# Configuration
PANEL_DIR="/opt/maut-panel"
CONFIG_DIR="$PANEL_DIR/config"
SCRIPT_DIR="$PANEL_DIR/scripts"
LOG_DIR="/var/log/maut-panel"
ACTIVITY_LOG="$LOG_DIR/maut-activity.log"
USER_DB="$CONFIG_DIR/maut-users.db"
THEME_FILE="$CONFIG_DIR/maut-theme.conf"

# Load theme
load_theme() {
    if [[ -f "$THEME_FILE" ]]; then
        source "$THEME_FILE"
    else
        COLOR_PRIMARY='\033[0;31m'
        COLOR_SECONDARY='\033[0;33m'
        COLOR_ACCENT='\033[0;36m'
        COLOR_SUCCESS='\033[0;32m'
        COLOR_WARNING='\033[1;33m'
        COLOR_ERROR='\033[0;31m'
        COLOR_INFO='\033[0;34m'
        COLOR_RESET='\033[0m'
    fi
}

# Logging
log_activity() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - ACTIVITY: $1" >> "$ACTIVITY_LOG"
}

# Show recent activity
show_recent_activity() {
    echo -e "${COLOR_INFO}Recent User Activity${COLOR_RESET}"
    echo "════════════════════════════════════════"
    echo ""
    
    if [[ ! -f "$ACTIVITY_LOG" ]]; then
        echo -e "${COLOR_WARNING}No activity log found${COLOR_RESET}"
        return
    fi
    
    echo "1. Last 20 activities"
    echo "2. Last 50 activities"
    echo "3. Today's activities"
    echo "4. Search activities"
    echo "5. Back to Menu"
    
    read -p "Enter choice (1-5): " choice
    
    case $choice in
        1)
            echo -e "${COLOR_SUCCESS}Last 20 Activities:${COLOR_RESET}"
            tail -20 "$ACTIVITY_LOG"
            ;;
        2)
            echo -e "${COLOR_SUCCESS}Last 50 Activities:${COLOR_RESET}"
            tail -50 "$ACTIVITY_LOG"
            ;;
        3)
            echo -e "${COLOR_SUCCESS}Today's Activities:${COLOR_RESET}"
            grep "$(date '+%Y-%m-%d')" "$ACTIVITY_LOG"
            ;;
        4)
            read -p "Enter search term: " search_term
            echo -e "${COLOR_SUCCESS}Search Results:${COLOR_RESET}"
            grep -i "$search_term" "$ACTIVITY_LOG" | tail -20
            ;;
        5)
            return
            ;;
        *)
            echo -e "${COLOR_ERROR}Invalid choice${COLOR_RESET}"
            ;;
    esac
}

# Show SSH connections
show_ssh_connections() {
    echo -e "${COLOR_INFO}Current SSH Connections${COLOR_RESET}"
    echo "════════════════════════════════════════"
    echo ""
    
    local connections=$(who)
    
    if [[ -z "$connections" ]]; then
        echo -e "${COLOR_WARNING}No active SSH connections${COLOR_RESET}"
        return
    fi
    
    echo -e "${COLOR_PRIMARY}User | IP Address | Login Time | Session${COLOR_RESET}"
    echo "─────┼─────────────┼─────────────┼────────"
    
    while read -r user tty ip time; do
        local session_info=$(ps -u "$user" -o pid,cmd | grep sshd | head -1 | awk '{print $1}')
        echo -e "$user | $ip | $time | $session_info"
    done <<< "$connections"
    
    echo ""
    echo -e "${COLOR_INFO}Total connections: $(who | wc -l)${COLOR_RESET}"
}

# Show user login history
show_login_history() {
    echo -e "${COLOR_INFO}User Login History${COLOR_RESET}"
    echo "════════════════════════════════════════"
    echo ""
    
    echo "1. Last 10 logins"
    echo "2. Last 50 logins"
    echo "3. Failed login attempts"
    echo "4. Specific user history"
    echo "5. Back to Menu"
    
    read -p "Enter choice (1-5): " choice
    
    case $choice in
        1)
            echo -e "${COLOR_SUCCESS}Last 10 Logins:${COLOR_RESET}"
            last -10
            ;;
        2)
            echo -e "${COLOR_SUCCESS}Last 50 Logins:${COLOR_RESET}"
            last -50
            ;;
        3)
            echo -e "${COLOR_SUCCESS}Failed Login Attempts:${COLOR_RESET}"
            if [[ -f "/var/log/auth.log" ]]; then
                grep "Failed password" /var/log/auth.log | tail -20
            elif [[ -f "/var/log/secure" ]]; then
                grep "Failed password" /var/log/secure | tail -20
            else
                echo -e "${COLOR_WARNING}Auth logs not found${COLOR_RESET}"
            fi
            ;;
        4)
            read -p "Enter username: " username
            if [[ -n "$username" ]]; then
                echo -e "${COLOR_SUCCESS}Login history for $username:${COLOR_RESET}"
                last "$username" | head -20
            fi
            ;;
        5)
            return
            ;;
        *)
            echo -e "${COLOR_ERROR}Invalid choice${COLOR_RESET}"
            ;;
    esac
}

# Show service usage statistics
show_service_stats() {
    echo -e "${COLOR_INFO}Service Usage Statistics${COLOR_RESET}"
    echo "════════════════════════════════════════"
    echo ""
    
    # Count users by service
    declare -A service_counts
    local total_users=0
    
    if [[ -f "$USER_DB" ]]; then
        while IFS='|' read -r service username _ _ _ _ _ status; do
            if [[ -n "$service" && "$status" == "active" ]]; then
                ((service_counts["$service"]++))
                ((total_users++))
            fi
        done < <(grep -v "^#" "$USER_DB")
    fi
    
    echo -e "${COLOR_SUCCESS}Active Users by Service:${COLOR_RESET}"
    echo -e "${COLOR_PRIMARY}Service | User Count | Percentage${COLOR_RESET}"
    echo "────────┼────────────┼───────────"
    
    for service in "${!service_counts[@]}"; do
        local count=${service_counts["$service"]}
        local percentage=$((count * 100 / total_users))
        echo -e "$service | $count | ${percentage}%"
    done
    
    echo ""
    echo -e "${COLOR_SUCCESS}Total Active Users: $total_users${COLOR_RESET}"
    
    # Show recent service activities
    echo ""
    echo -e "${COLOR_SUCCESS}Recent Service Activities:${COLOR_RESET}"
    grep -E "(SSH|VMESS|VLESS|TROJAN|SHADOWSOCKS):" "$ACTIVITY_LOG" 2>/dev/null | tail -10 || echo "No recent service activities"
}

# Monitor real-time activity
realtime_activity_monitor() {
    echo -e "${COLOR_INFO}Real-time Activity Monitor${COLOR_RESET}"
    echo -e "${COLOR_WARNING}Press Ctrl+C to stop monitoring${COLOR_RESET}"
    echo "════════════════════════════════════════"
    echo ""
    
    # Create a temporary log file for monitoring
    local temp_log="/tmp/maut_realtime.log"
    touch "$temp_log"
    
    # Function to display activities
    show_activities() {
        clear
        echo -e "${COLOR_INFO}Real-time Activity Monitor - $(date)${COLOR_RESET}"
        echo "════════════════════════════════════════"
        echo ""
        
        # Show recent activities
        tail -10 "$ACTIVITY_LOG" 2>/dev/null | while read -r line; do
            echo -e "${COLOR_INFO}$line${COLOR_RESET}"
        done
        
        echo ""
        echo -e "${COLOR_SUCCESS}Current SSH Connections:$(who | wc -l)${COLOR_RESET}"
        echo -e "${COLOR_WARNING}Monitoring... Press Ctrl+C to stop${COLOR_RESET}"
    }
    
    # Monitor for new activities
    trap 'rm -f "$temp_log"; echo -e "\nMonitoring stopped"; return' INT
    
    local last_size=0
    while true; do
        local current_size=$(stat -c%s "$ACTIVITY_LOG" 2>/dev/null || echo 0)
        
        if [[ $current_size -ne $last_size ]]; then
            show_activities
            last_size=$current_size
        fi
        
        sleep 5
    done
}

# User session details
show_user_sessions() {
    echo -e "${COLOR_INFO}Detailed User Sessions${COLOR_RESET}"
    echo "════════════════════════════════════════"
    echo ""
    
    echo "1. Show all user processes"
    echo "2. Show SSH sessions detail"
    echo "3. Show active service users"
    echo "4. Back to Menu"
    
    read -p "Enter choice (1-4): " choice
    
    case $choice in
        1)
            echo -e "${COLOR_SUCCESS}All User Processes:${COLOR_RESET}"
            ps aux --sort=-%cpu | head -20
            ;;
        2)
            echo -e "${COLOR_SUCCESS}SSH Session Details:${COLOR_RESET}"
            if command -v w &> /dev/null; then
                w
            else
                who
                echo ""
                echo -e "${COLOR_INFO}Active Processes:${COLOR_RESET}"
                ps aux | grep sshd | grep -v grep
            fi
            ;;
        3)
            echo -e "${COLOR_SUCCESS}Active Service Users:${COLOR_RESET}"
            # This would show users connected to various services
            echo -e "${COLOR_INFO}Xray Connections:${COLOR_RESET}"
            netstat -tulpn | grep xray | wc -l
            echo -e "${COLOR_INFO}SSH Connections:${COLOR_RESET}"
            who | wc -l
            echo -e "${COLOR_INFO}Web Connections:${COLOR_RESET}"
            netstat -tulpn | grep :80 | wc -l
            netstat -tulpn | grep :443 | wc -l
            ;;
        4)
            return
            ;;
        *)
            echo -e "${COLOR_ERROR}Invalid choice${COLOR_RESET}"
            ;;
    esac
}

# Generate activity report
generate_activity_report() {
    echo -e "${COLOR_INFO}Generate Activity Report${COLOR_RESET}"
    echo ""
    
    local report_dir="$PANEL_DIR/reports"
    local timestamp=$(date +%Y%m%d_%H%M%S)
    local report_file="$report_dir/activity_report_$timestamp.txt"
    
    mkdir -p "$report_dir"
    
    echo -e "${COLOR_INFO}Generating comprehensive activity report...${COLOR_RESET}"
    
    # Create the report
    {
        echo "MAUT PANEL PRO - ACTIVITY REPORT"
        echo "Generated: $(date)"
        echo "════════════════════════════════════════"
        echo ""
        
        echo "1. CURRENT SSH CONNECTIONS:"
        echo "──────────────────────────"
        who
        echo ""
        
        echo "2. RECENT LOGIN HISTORY:"
        echo "───────────────────────"
        last -20
        echo ""
        
        echo "3. RECENT ACTIVITIES:"
        echo "────────────────────"
        tail -30 "$ACTIVITY_LOG" 2>/dev/null || echo "No activity log"
        echo ""
        
        echo "4. SERVICE USAGE STATISTICS:"
        echo "───────────────────────────"
        declare -A service_counts
        local total_users=0
        
        if [[ -f "$USER_DB" ]]; then
            while IFS='|' read -r service username _ _ _ _ _ status; do
                if [[ -n "$service" && "$status" == "active" ]]; then
                    ((service_counts["$service"]++))
                    ((total_users++))
                fi
            done < <(grep -v "^#" "$USER_DB")
        fi
        
        for service in "${!service_counts[@]}"; do
            echo "$service: ${service_counts["$service"]} users"
        done
        echo "Total Active Users: $total_users"
        echo ""
        
        echo "5. SYSTEM STATUS:"
        echo "────────────────"
        echo "Uptime: $(uptime -p)"
        echo "Load: $(uptime | awk -F'load average:' '{print $2}')"
        echo "Memory: $(free -h | grep Mem | awk '{print $3"/"$2}')"
        echo "Disk: $(df -h / | awk 'NR==2 {print $3"/"$2 " ("$5")"}')"
        
    } > "$report_file"
    
    echo -e "${COLOR_SUCCESS}Activity report generated: $report_file${COLOR_RESET}"
    log_activity "Generated activity report: $(basename "$report_file")"
}

# Clean old activity logs
clean_activity_logs() {
    echo -e "${COLOR_INFO}Clean Activity Logs${COLOR_RESET}"
    echo ""
    
    echo -e "${COLOR_WARNING}This will clean old activity logs${COLOR_RESET}"
    read -p "Are you sure? (y/N): " confirm
    
    if [[ "$confirm" == "y" || "$confirm" == "Y" ]]; then
        # Backup current log
        local backup_file="$LOG_DIR/maut-activity.backup.$(date +%Y%m%d)"
        cp "$ACTIVITY_LOG" "$backup_file" 2>/dev/null
        
        # Clear the log
        echo -n "" > "$ACTIVITY_LOG"
        
        echo -e "${COLOR_SUCCESS}Activity logs cleaned. Backup created: $(basename "$backup_file")${COLOR_RESET}"
        log_activity "Activity logs cleaned by user"
    else
        echo "Operation cancelled"
    fi
}

# Activity menu
show_activity_menu() {
    clear
    echo -e "${COLOR_PRIMARY}"
    echo " ╔══════════════════════════════════════╗"
    echo " ║         USER ACTIVITY MONITOR       ║"
    echo " ║           MAUT PANEL PRO            ║"
    echo " ╚══════════════════════════════════════╝"
    echo -e "${COLOR_RESET}"
    echo -e "${COLOR_INFO}Monitor user activities and system usage${COLOR_RESET}"
    echo "════════════════════════════════════════"
    echo ""
    
    # Show quick stats
    echo -e "${COLOR_SUCCESS}Quick Stats:${COLOR_RESET}"
    echo -e "SSH Connections: $(who | wc -l)"
    echo -e "Today's Activities: $(grep "$(date '+%Y-%m-%d')" "$ACTIVITY_LOG" 2>/dev/null | wc -l || echo 0)"
    echo ""
    
    echo -e "${COLOR_PRIMARY}ACTIVITY MENU:${COLOR_RESET}"
    echo -e "${COLOR_SUCCESS}01${COLOR_RESET} Recent Activity"
    echo -e "${COLOR_SUCCESS}02${COLOR_RESET} SSH Connections"
    echo -e "${COLOR_SUCCESS}03${COLOR_RESET} Login History"
    echo -e "${COLOR_SUCCESS}04${COLOR_RESET} Service Statistics"
    echo -e "${COLOR_SUCCESS}05${COLOR_RESET} Real-time Monitor"
    echo -e "${COLOR_SUCCESS}06${COLOR_RESET} User Sessions"
    echo -e "${COLOR_SUCCESS}07${COLOR_RESET} Generate Report"
    echo -e "${COLOR_SUCCESS}08${COLOR_RESET} Clean Logs"
    echo -e "${COLOR_SUCCESS}09${COLOR_RESET} Back to Main Menu"
    echo ""
}

# Main activity function
main() {
    load_theme
    
    while true; do
        show_activity_menu
        
        read -p "Enter your choice: " choice
        echo ""
        
        case $choice in
            01) show_recent_activity ;;
            02) show_ssh_connections ;;
            03) show_login_history ;;
            04) show_service_stats ;;
            05) realtime_activity_monitor ;;
            06) show_user_sessions ;;
            07) generate_activity_report ;;
            08) clean_activity_logs ;;
            09) 
                log_activity "Exited Activity Monitor"
                break 
                ;;
            *) 
                echo -e "${COLOR_ERROR}Invalid choice! Please try again.${COLOR_RESET}"
                ;;
        esac
        
        echo ""
        read -p "Press Enter to continue..."
    done
}

# Start main function
main "$@"