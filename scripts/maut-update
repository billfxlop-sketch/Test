#!/bin/bash

# MAUT PANEL PRO EDITION - UPDATE SCRIPT
# Owner: @maut_coder
# Powered by MAUT CODER

# Configuration
PANEL_DIR="/opt/maut-panel"
CONFIG_DIR="$PANEL_DIR/config"
SCRIPT_DIR="$PANEL_DIR/scripts"
BACKUP_DIR="$PANEL_DIR/backup"
LOG_DIR="/var/log/maut-panel"
UPDATE_LOG="$LOG_DIR/maut-update.log"
THEME_FILE="$CONFIG_DIR/maut-theme.conf"

# GitHub repository info (placeholder - replace with actual repo)
GITHUB_REPO="maut-coder/maut-panel-pro"
GITHUB_BRANCH="main"

# Load theme
load_theme() {
    if [[ -f "$THEME_FILE" ]]; then
        source "$THEME_FILE"
    else
        COLOR_PRIMARY='\033[0;31m'
        COLOR_SECONDARY='\033[0;33m'
        COLOR_ACCENT='\033[0;36m'
        COLOR_SUCCESS='\033[0;32m'
        COLOR_WARNING='\033[1;33m'
        COLOR_ERROR='\033[0;31m'
        COLOR_INFO='\033[0;34m'
        COLOR_RESET='\033[0m'
    fi
}

# Logging
log_update() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - UPDATE: $1" >> "$UPDATE_LOG"
}

# Check for updates
check_for_updates() {
    echo -e "${COLOR_INFO}Checking for updates...${COLOR_RESET}"
    echo ""
    
    # This is a placeholder implementation
    # In a real scenario, you would check against a remote repository
    
    local current_version="2.1"
    local latest_version="2.1"
    
    echo -e "${COLOR_SUCCESS}Current Version: ${COLOR_RESET}$current_version"
    echo -e "${COLOR_SUCCESS}Latest Version: ${COLOR_RESET}$latest_version"
    echo ""
    
    if [[ "$current_version" == "$latest_version" ]]; then
        echo -e "${COLOR_SUCCESS}✓ Your MAUT Panel Pro is up to date${COLOR_RESET}"
        return 0
    else
        echo -e "${COLOR_WARNING}⚠ Update available!${COLOR_RESET}"
        echo -e "Current: $current_version"
        echo -e "Latest: $latest_version"
        return 1
    fi
}

# Backup before update
backup_before_update() {
    echo -e "${COLOR_INFO}Creating backup before update...${COLOR_RESET}"
    
    local timestamp=$(date +%Y%m%d_%H%M%S)
    local backup_name="pre_update_backup_$timestamp"
    local backup_path="$BACKUP_DIR/$backup_name.tar.gz"
    
    mkdir -p "$BACKUP_DIR"
    
    # Create backup of critical files
    tar -czf "$backup_path" \
        "$CONFIG_DIR" \
        "$SCRIPT_DIR" \
        "/usr/local/etc/xray/config.json" 2>/dev/null
    
    if [ $? -eq 0 ]; then
        echo -e "${COLOR_SUCCESS}✓ Backup created: $backup_path${COLOR_RESET}"
        log_update "Created pre-update backup: $backup_name.tar.gz"
        return 0
    else
        echo -e "${COLOR_ERROR}✗ Backup creation failed${COLOR_RESET}"
        return 1
    fi
}

# Update panel scripts
update_panel_scripts() {
    echo -e "${COLOR_INFO}Updating panel scripts...${COLOR_RESET}"
    
    # This is a placeholder implementation
    # In a real scenario, you would download from GitHub
    
    echo -e "${COLOR_WARNING}Update simulation - no actual files changed${COLOR_RESET}"
    echo ""
    
    # Simulate file updates
    local files_to_update=(
        "maut-main"
        "maut-ssh" 
        "maut-vmess"
        "maut-vless"
        "maut-trojan"
        "maut-xray"
        "maut-ss"
        "maut-ws"
        "maut-domain"
        "maut-backup"
        "maut-monitor"
        "maut-speedtest"
        "maut-theme"
        "maut-banner"
        "maut-helper"
    )
    
    for file in "${files_to_update[@]}"; do
        echo -e "Updating $file... ${COLOR_SUCCESS}✓${COLOR_RESET}"
        sleep 0.1
    done
    
    echo ""
    echo -e "${COLOR_SUCCESS}Panel scripts updated successfully${COLOR_RESET}"
    log_update "Updated panel scripts"
}

# Update Xray core
update_xray_core() {
    echo -e "${COLOR_INFO}Updating Xray core...${COLOR_RESET}"
    echo ""
    
    # Check current Xray version
    if command -v xray &> /dev/null; then
        local current_version=$(xray version | head -n1 | awk '{print $2}')
        echo -e "Current Xray version: $current_version"
    fi
    
    echo -e "${COLOR_WARNING}This will update Xray to the latest version${COLOR_RESET}"
    read -p "Continue with Xray update? (y/N): " confirm
    
    if [[ "$confirm" != "y" && "$confirm" != "Y" ]]; then
        echo -e "${COLOR_INFO}Xray update skipped${COLOR_RESET}"
        return 0
    fi
    
    # Backup Xray config
    local xray_config="/usr/local/etc/xray/config.json"
    if [[ -f "$xray_config" ]]; then
        cp "$xray_config" "$xray_config.backup.$(date +%s)"
        echo -e "${COLOR_SUCCESS}Xray configuration backed up${COLOR_RESET}"
    fi
    
    # Update Xray using official script
    echo -e "${COLOR_INFO}Downloading and installing latest Xray...${COLOR_RESET}"
    bash -c "$(curl -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)" @ install
    
    if [ $? -eq 0 ]; then
        local new_version=$(xray version | head -n1 | awk '{print $2}')
        echo -e "${COLOR_SUCCESS}✓ Xray updated to version: $new_version${COLOR_RESET}"
        log_update "Updated Xray core to $new_version"
        
        # Restart Xray service
        systemctl restart xray
        echo -e "${COLOR_SUCCESS}Xray service restarted${COLOR_RESET}"
    else
        echo -e "${COLOR_ERROR}✗ Xray update failed${COLOR_RESET}"
        return 1
    fi
}

# Update system dependencies
update_dependencies() {
    echo -e "${COLOR_INFO}Updating system dependencies...${COLOR_RESET}"
    echo ""
    
    # Detect package manager
    if command -v apt-get &> /dev/null; then
        echo -e "${COLOR_INFO}Updating using apt-get...${COLOR_RESET}"
        apt-get update
        apt-get upgrade -y
    elif command -v yum &> /dev/null; then
        echo -e "${COLOR_INFO}Updating using yum...${COLOR_RESET}"
        yum update -y
    else
        echo -e "${COLOR_WARNING}Could not detect package manager${COLOR_RESET}"
        return 1
    fi
    
    echo -e "${COLOR_SUCCESS}✓ System dependencies updated${COLOR_RESET}"
    log_update "Updated system dependencies"
}

# Verify update
verify_update() {
    echo -e "${COLOR_INFO}Verifying update...${COLOR_RESET}"
    echo ""
    
    local errors=0
    
    # Check if essential scripts are executable
    local essential_scripts=(
        "maut-main"
        "maut-ssh"
        "maut-xray"
        "maut-backup"
    )
    
    for script in "${essential_scripts[@]}"; do
        if [[ -x "$SCRIPT_DIR/$script" ]]; then
            echo -e "✓ $script: ${COLOR_SUCCESS}Executable${COLOR_RESET}"
        else
            echo -e "✗ $script: ${COLOR_ERROR}Not executable${COLOR_RESET}"
            ((errors++))
        fi
    done
    
    # Check if Xray is running
    if systemctl is-active --quiet xray; then
        echo -e "✓ Xray service: ${COLOR_SUCCESS}Running${COLOR_RESET}"
    else
        echo -e "✗ Xray service: ${COLOR_ERROR}Stopped${COLOR_RESET}"
        ((errors++))
    fi
    
    # Check if SSH is running
    if systemctl is-active --quiet ssh; then
        echo -e "✓ SSH service: ${COLOR_SUCCESS}Running${COLOR_RESET}"
    else
        echo -e "✗ SSH service: ${COLOR_ERROR}Stopped${COLOR_RESET}"
        ((errors++))
    fi
    
    echo ""
    
    if [[ $errors -eq 0 ]]; then
        echo -e "${COLOR_SUCCESS}✓ Update verification passed${COLOR_RESET}"
        return 0
    else
        echo -e "${COLOR_ERROR}✗ Update verification failed with $errors error(s)${COLOR_RESET}"
        return 1
    fi
}

# Perform full update
perform_full_update() {
    echo -e "${COLOR_INFO}Starting MAUT Panel Pro Update${COLOR_RESET}"
    echo "════════════════════════════════════════"
    echo ""
    
    # Check for updates first
    if ! check_for_updates; then
        echo -e "${COLOR_WARNING}Update available!${COLOR_RESET}"
    else
        echo -e "${COLOR_INFO}No updates available, but you can force reinstall.${COLOR_RESET}"
    fi
    
    echo ""
    echo -e "${COLOR_WARNING}This will:${COLOR_RESET}"
    echo "• Create a backup of current installation"
    echo "• Update panel scripts"
    echo "• Update Xray core (optional)"
    echo "• Update system dependencies"
    echo "• Restart services"
    echo ""
    echo -e "${COLOR_WARNING}Services may be briefly interrupted during update${COLOR_RESET}"
    echo ""
    
    read -p "Are you sure you want to continue? (y/N): " confirm
    
    if [[ "$confirm" != "y" && "$confirm" != "Y" ]]; then
        echo "Update cancelled"
        return
    fi
    
    # Start update process
    echo ""
    echo -e "${COLOR_PRIMARY}Starting update process...${COLOR_RESET}"
    echo ""
    
    # Step 1: Backup
    if ! backup_before_update; then
        echo -e "${COLOR_ERROR}Backup failed, aborting update${COLOR_RESET}"
        return 1
    fi
    
    # Step 2: Update dependencies
    if ! update_dependencies; then
        echo -e "${COLOR_WARNING}Dependency update had issues, continuing...${COLOR_RESET}"
    fi
    
    # Step 3: Update panel scripts
    if ! update_panel_scripts; then
        echo -e "${COLOR_ERROR}Panel script update failed${COLOR_RESET}"
        return 1
    fi
    
    # Step 4: Update Xray (optional)
    update_xray_core
    
    # Step 5: Verify update
    if ! verify_update; then
        echo -e "${COLOR_ERROR}Update verification failed${COLOR_RESET}"
        echo -e "${COLOR_INFO}Check the logs and consider restoring from backup${COLOR_RESET}"
        return 1
    fi
    
    # Final success message
    echo ""
    echo -e "${COLOR_SUCCESS}╔══════════════════════════════════════╗${COLOR_RESET}"
    echo -e "${COLOR_SUCCESS}║         UPDATE COMPLETED!           ║${COLOR_RESET}"
    echo -e "${COLOR_SUCCESS}║           MAUT PANEL PRO            ║${COLOR_RESET}"
    echo -e "${COLOR_SUCCESS}╚══════════════════════════════════════╝${COLOR_RESET}"
    echo ""
    echo -e "${COLOR_INFO}All updates have been applied successfully${COLOR_RESET}"
    echo -e "${COLOR_INFO}Backup created in: $BACKUP_DIR${COLOR_RESET}"
    echo ""
    
    log_update "Full update completed successfully"
}

# Update only panel scripts
update_panel_only() {
    echo -e "${COLOR_INFO}Updating Panel Scripts Only${COLOR_RESET}"
    echo ""
    
    echo -e "${COLOR_WARNING}This will update only the panel scripts${COLOR_RESET}"
    echo -e "${COLOR_WARNING}Xray and system packages will not be updated${COLOR_RESET}"
    echo ""
    
    read -p "Continue? (y/N): " confirm
    
    if [[ "$confirm" != "y" && "$confirm" != "Y" ]]; then
        echo "Update cancelled"
        return
    fi
    
    # Backup
    backup_before_update
    
    # Update scripts
    update_panel_scripts
    
    # Verify
    verify_update
    
    echo -e "${COLOR_SUCCESS}Panel scripts update completed${COLOR_RESET}"
    log_update "Panel scripts only update completed"
}

# Rollback update
rollback_update() {
    echo -e "${COLOR_INFO}Rollback Update${COLOR_RESET}"
    echo ""
    
    local backups=($(ls -t "$BACKUP_DIR"/pre_update_backup_*.tar.gz 2>/dev/null))
    
    if [[ ${#backups[@]} -eq 0 ]]; then
        echo -e "${COLOR_ERROR}No update backups found${COLOR_RESET}"
        return 1
    fi
    
    echo -e "${COLOR_WARNING}This will restore the panel from a previous backup${COLOR_RESET}"
    echo -e "${COLOR_WARNING}Current configuration will be replaced!${COLOR_RESET}"
    echo ""
    
    echo -e "${COLOR_INFO}Available backups:${COLOR_RESET}"
    local i=1
    for backup in "${backups[@]}"; do
        local filename=$(basename "$backup")
        local size=$(du -h "$backup" | cut -f1)
        local date=$(stat -c %y "$backup" | cut -d' ' -f1-2)
        echo "$i. $filename ($size) - $date"
        ((i++))
    done
    
    echo ""
    read -p "Select backup to restore (1-${#backups[@]}): " choice
    
    if [[ ! "$choice" =~ ^[0-9]+$ ]] || [ "$choice" -lt 1 ] || [ "$choice" -gt ${#backups[@]} ]; then
        echo -e "${COLOR_ERROR}Invalid selection${COLOR_RESET}"
        return 1
    fi
    
    local selected_backup="${backups[$((choice-1))]}"
    
    echo -e "${COLOR_WARNING}Restoring from: $(basename "$selected_backup")${COLOR_RESET}"
    read -p "Are you sure? This cannot be undone! (y/N): " confirm
    
    if [[ "$confirm" != "y" && "$confirm" != "Y" ]]; then
        echo "Rollback cancelled"
        return
    fi
    
    # Stop services
    systemctl stop xray 2>/dev/null
    
    # Extract backup
    echo -e "${COLOR_INFO}Restoring backup...${COLOR_RESET}"
    tar -xzf "$selected_backup" -C "/"
    
    # Restart services
    systemctl start xray 2>/dev/null
    
    echo -e "${COLOR_SUCCESS}Rollback completed!${COLOR_RESET}"
    log_update "Rollback from $(basename "$selected_backup")"
}

# Show update history
show_update_history() {
    echo -e "${COLOR_INFO}Update History${COLOR_RESET}"
    echo ""
    
    if [[ -f "$UPDATE_LOG" ]]; then
        echo "1. View last 10 updates"
        echo "2. View last 20 updates"
        echo "3. View all updates"
        echo "4. Clear history"
        echo "5. Back to menu"
        
        read -p "Enter your choice: " choice
        
        case $choice in
            1)
                tail -10 "$UPDATE_LOG"
                ;;
            2)
                tail -20 "$UPDATE_LOG"
                ;;
            3)
                cat "$UPDATE_LOG"
                ;;
            4)
                echo -n "" > "$UPDATE_LOG"
                echo -e "${COLOR_SUCCESS}Update history cleared${COLOR_RESET}"
                ;;
            5)
                return
                ;;
            *)
                echo -e "${COLOR_ERROR}Invalid choice${COLOR_RESET}"
                ;;
        esac
    else
        echo -e "${COLOR_WARNING}No update history found${COLOR_RESET}"
    fi
}

# Auto-update (for cron jobs)
auto_update() {
    echo -e "${COLOR_INFO}Auto-update check...${COLOR_RESET}"
    
    # This would check for updates and apply them automatically
    # For safety, we'll just log the check
    log_update "Auto-update check performed"
    
    # In a real implementation, you might:
    # 1. Check for updates
    # 2. Download if available
    # 3. Create backup
    # 4. Apply updates
    # 5. Restart services if needed
    
    echo -e "${COLOR_INFO}Auto-update check completed${COLOR_RESET}"
}

# Update menu
show_update_menu() {
    clear
    load_theme
    
    echo -e "${COLOR_PRIMARY}"
    echo " ╔══════════════════════════════════════╗"
    echo " ║            UPDATE MANAGER           ║"
    echo " ║           MAUT PANEL PRO            ║"
    echo " ╚══════════════════════════════════════╝"
    echo -e "${COLOR_RESET}"
    echo -e "${COLOR_INFO}Update your MAUT Panel Pro installation${COLOR_RESET}"
    echo "════════════════════════════════════════"
    echo ""
    
    # Show current version
    echo -e "${COLOR_SUCCESS}Current Version: 2.1${COLOR_RESET}"
    
    # Check for updates
    if check_for_updates; then
        echo -e "${COLOR_SUCCESS}Status: Up to date${COLOR_RESET}"
    else
        echo -e "${COLOR_WARNING}Status: Update available${COLOR_RESET}"
    fi
    
    echo ""
    
    echo -e "${COLOR_PRIMARY}UPDATE MENU:${COLOR_RESET}"
    echo -e "${COLOR_SUCCESS}01${COLOR_RESET} Check for Updates"
    echo -e "${COLOR_SUCCESS}02${COLOR_RESET} Full Update"
    echo -e "${COLOR_SUCCESS}03${COLOR_RESET} Update Panel Only"
    echo -e "${COLOR_SUCCESS}04${COLOR_RESET} Update Xray Core"
    echo -e "${COLOR_SUCCESS}05${COLOR_RESET} Update Dependencies"
    echo -e "${COLOR_SUCCESS}06${COLOR_RESET} Rollback Update"
    echo -e "${COLOR_SUCCESS}07${COLOR_RESET} Update History"
    echo -e "${COLOR_SUCCESS}08${COLOR_RESET} Back to Main Menu"
    echo ""
}

# Main update function
main() {
    load_theme
    
    # Handle auto-update if argument passed
    if [[ "$1" == "auto" ]]; then
        auto_update
        return
    fi
    
    while true; do
        show_update_menu
        
        read -p "Enter your choice: " choice
        echo ""
        
        case $choice in
            01) check_for_updates ;;
            02) perform_full_update ;;
            03) update_panel_only ;;
            04) update_xray_core ;;
            05) update_dependencies ;;
            06) rollback_update ;;
            07) show_update_history ;;
            08) 
                log_update "Exited Update Manager"
                break 
                ;;
            *) 
                echo -e "${COLOR_ERROR}Invalid choice! Please try again.${COLOR_RESET}"
                ;;
        esac
        
        echo ""
        read -p "Press Enter to continue..."
    done
}

# Start main function
main "$@"