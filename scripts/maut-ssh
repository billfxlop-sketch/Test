#!/bin/bash

# MAUT PANEL PRO EDITION - SSH MANAGER
# Owner: @maut_coder
# Powered by MAUT CODER

# Configuration
PANEL_DIR="/opt/maut-panel"
CONFIG_DIR="$PANEL_DIR/config"
SCRIPT_DIR="$PANEL_DIR/scripts"
LOG_DIR="/var/log/maut-panel"
USER_DB="$CONFIG_DIR/maut-users.db"
THEME_FILE="$CONFIG_DIR/maut-theme.conf"

# Load theme
load_theme() {
    if [[ -f "$THEME_FILE" ]]; then
        source "$THEME_FILE"
    else
        COLOR_PRIMARY='\033[0;31m'
        COLOR_SECONDARY='\033[0;33m'
        COLOR_ACCENT='\033[0;36m'
        COLOR_SUCCESS='\033[0;32m'
        COLOR_WARNING='\033[1;33m'
        COLOR_ERROR='\033[0;31m'
        COLOR_INFO='\033[0;34m'
        COLOR_RESET='\033[0m'
    fi
}

# Logging
log_action() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - SSH: $1" >> "$LOG_DIR/maut-actions.log"
}

# Check if user exists in database
user_exists() {
    grep -q "^$1|" "$USER_DB"
}

# Add user to database
add_user_to_db() {
    local username="$1"
    local password="$2"
    local expiry="$3"
    local created=$(date '+%Y-%m-%d')
    
    echo "$username|$password|$expiry|$created|active" >> "$USER_DB"
    log_action "Added SSH user: $username (Expiry: $expiry)"
}

# Remove user from database
remove_user_from_db() {
    local username="$1"
    sed -i "/^$username|/d" "$USER_DB"
    log_action "Removed SSH user: $username"
}

# Create SSH user
create_ssh_user() {
    echo -e "${COLOR_INFO}Creating SSH User${COLOR_RESET}"
    echo ""
    
    read -p "Enter username: " username
    if [[ -z "$username" ]]; then
        echo -e "${COLOR_ERROR}Username cannot be empty${COLOR_RESET}"
        return 1
    fi
    
    if user_exists "$username"; then
        echo -e "${COLOR_ERROR}User already exists${COLOR_RESET}"
        return 1
    fi
    
    read -s -p "Enter password: " password
    echo
    if [[ -z "$password" ]]; then
        echo -e "${COLOR_ERROR}Password cannot be empty${COLOR_RESET}"
        return 1
    fi
    
    read -p "Enter expiry date (YYYY-MM-DD): " expiry
    if [[ ! "$expiry" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
        echo -e "${COLOR_ERROR}Invalid date format. Use YYYY-MM-DD${COLOR_RESET}"
        return 1
    fi
    
    # Create system user
    useradd -m -s /bin/false "$username" 2>/dev/null
    if [ $? -ne 0 ]; then
        echo -e "${COLOR_ERROR}Failed to create system user${COLOR_RESET}"
        return 1
    fi
    
    # Set password
    echo "$username:$password" | chpasswd
    
    # Add to database
    add_user_to_db "$username" "$password" "$expiry"
    
    echo -e "${COLOR_SUCCESS}SSH user created successfully!${COLOR_RESET}"
    echo -e "${COLOR_INFO}Username: ${COLOR_SUCCESS}$username${COLOR_RESET}"
    echo -e "${COLOR_INFO}Password: ${COLOR_SUCCESS}$password${COLOR_RESET}"
    echo -e "${COLOR_INFO}Expiry: ${COLOR_SUCCESS}$expiry${COLOR_RESET}"
}

# Delete SSH user
delete_ssh_user() {
    echo -e "${COLOR_INFO}Delete SSH User${COLOR_RESET}"
    echo ""
    
    read -p "Enter username to delete: " username
    if [[ -z "$username" ]]; then
        echo -e "${COLOR_ERROR}Username cannot be empty${COLOR_RESET}"
        return 1
    fi
    
    if ! user_exists "$username"; then
        echo -e "${COLOR_ERROR}User not found${COLOR_RESET}"
        return 1
    fi
    
    # Remove system user
    userdel -r "$username" 2>/dev/null
    
    # Remove from database
    remove_user_from_db "$username"
    
    echo -e "${COLOR_SUCCESS}User $username deleted successfully${COLOR_RESET}"
}

# List SSH users
list_ssh_users() {
    echo -e "${COLOR_INFO}SSH Users List${COLOR_RESET}"
    echo ""
    
    if [[ ! -f "$USER_DB" ]] || [[ ! -s "$USER_DB" ]]; then
        echo -e "${COLOR_WARNING}No SSH users found${COLOR_RESET}"
        return
    fi
    
    echo -e "${COLOR_PRIMARY}Username | Password | Expiry | Created | Status${COLOR_RESET}"
    echo "─────────┼──────────┼─────────────┼─────────────┼────────"
    
    while IFS='|' read -r username password expiry created status; do
        # Check if user is expired
        current_date=$(date '+%Y-%m-%d')
        if [[ "$expiry" < "$current_date" ]]; then
            status="expired"
            # Update status in database
            sed -i "s/^$username|.*|active$/ $username|$password|$expiry|$created|expired/" "$USER_DB"
        fi
        
        echo -e "$username | $password | $expiry | $created | $status"
    done < "$USER_DB"
}

# Renew SSH user
renew_ssh_user() {
    echo -e "${COLOR_INFO}Renew SSH User${COLOR_RESET}"
    echo ""
    
    read -p "Enter username to renew: " username
    if [[ -z "$username" ]]; then
        echo -e "${COLOR_ERROR}Username cannot be empty${COLOR_RESET}"
        return 1
    fi
    
    if ! user_exists "$username"; then
        echo -e "${COLOR_ERROR}User not found${COLOR_RESET}"
        return 1
    fi
    
    read -p "Enter new expiry date (YYYY-MM-DD): " new_expiry
    if [[ ! "$new_expiry" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
        echo -e "${COLOR_ERROR}Invalid date format. Use YYYY-MM-DD${COLOR_RESET}"
        return 1
    fi
    
    # Update expiry in database
    local user_data=$(grep "^$username|" "$USER_DB")
    local password=$(echo "$user_data" | cut -d'|' -f2)
    local created=$(echo "$user_data" | cut -d'|' -f4)
    
    sed -i "/^$username|/d" "$USER_DB"
    echo "$username|$password|$new_expiry|$created|active" >> "$USER_DB"
    
    log_action "Renewed SSH user: $username until $new_expiry"
    echo -e "${COLOR_SUCCESS}User $username renewed until $new_expiry${COLOR_RESET}"
}

# Change SSH user password
change_ssh_password() {
    echo -e "${COLOR_INFO}Change SSH User Password${COLOR_RESET}"
    echo ""
    
    read -p "Enter username: " username
    if [[ -z "$username" ]]; then
        echo -e "${COLOR_ERROR}Username cannot be empty${COLOR_RESET}"
        return 1
    fi
    
    if ! user_exists "$username"; then
        echo -e "${COLOR_ERROR}User not found${COLOR_RESET}"
        return 1
    fi
    
    read -s -p "Enter new password: " new_password
    echo
    if [[ -z "$new_password" ]]; then
        echo -e "${COLOR_ERROR}Password cannot be empty${COLOR_RESET}"
        return 1
    fi
    
    # Change system password
    echo "$username:$new_password" | chpasswd
    
    # Update database
    local user_data=$(grep "^$username|" "$USER_DB")
    local expiry=$(echo "$user_data" | cut -d'|' -f3)
    local created=$(echo "$user_data" | cut -d'|' -f4)
    
    sed -i "/^$username|/d" "$USER_DB"
    echo "$username|$new_password|$expiry|$created|active" >> "$USER_DB"
    
    log_action "Changed password for SSH user: $username"
    echo -e "${COLOR_SUCCESS}Password changed successfully for user $username${COLOR_RESET}"
}

# Show SSH service status
show_ssh_status() {
    echo -e "${COLOR_INFO}SSH Service Status${COLOR_RESET}"
    echo ""
    
    systemctl status ssh | head -10
    echo ""
    echo -e "${COLOR_INFO}SSH Connections:${COLOR_RESET}"
    netstat -tulpn | grep :22
    echo ""
    echo -e "${COLOR_INFO}Active SSH Sessions:${COLOR_RESET}"
    who
}

# SSH menu
show_ssh_menu() {
    clear
    echo -e "${COLOR_PRIMARY}"
    echo " ╔══════════════════════════════════════╗"
    echo " ║            SSH USER MANAGER         ║"
    echo " ║           MAUT PANEL PRO            ║"
    echo " ╚══════════════════════════════════════╝"
    echo -e "${COLOR_RESET}"
    echo -e "${COLOR_INFO}Manage SSH users and configurations${COLOR_RESET}"
    echo "════════════════════════════════════════"
    echo ""
    
    echo -e "${COLOR_PRIMARY}SSH MENU:${COLOR_RESET}"
    echo -e "${COLOR_SUCCESS}01${COLOR_RESET} Create SSH User"
    echo -e "${COLOR_SUCCESS}02${COLOR_RESET} Delete SSH User"
    echo -e "${COLOR_SUCCESS}03${COLOR_RESET} List SSH Users"
    echo -e "${COLOR_SUCCESS}04${COLOR_RESET} Renew SSH User"
    echo -e "${COLOR_SUCCESS}05${COLOR_RESET} Change Password"
    echo -e "${COLOR_SUCCESS}06${COLOR_RESET} SSH Service Status"
    echo -e "${COLOR_SUCCESS}07${COLOR_RESET} Active SSH Sessions"
    echo -e "${COLOR_SUCCESS}08${COLOR_RESET} Back to Main Menu"
    echo ""
}

# Main SSH function
main() {
    load_theme
    
    # Handle renew all if argument passed
    if [[ "$1" == "renew" ]]; then
        renew_ssh_user
        return
    fi
    
    while true; do
        show_ssh_menu
        
        read -p "Enter your choice: " choice
        echo ""
        
        case $choice in
            01) create_ssh_user ;;
            02) delete_ssh_user ;;
            03) list_ssh_users ;;
            04) renew_ssh_user ;;
            05) change_ssh_password ;;
            06) show_ssh_status ;;
            07) 
                echo -e "${COLOR_INFO}Active SSH Sessions:${COLOR_RESET}"
                who
                ;;
            08) 
                log_action "Exited SSH Manager"
                break 
                ;;
            *) 
                echo -e "${COLOR_ERROR}Invalid choice! Please try again.${COLOR_RESET}"
                ;;
        esac
        
        echo ""
        read -p "Press Enter to continue..."
    done
}

# Start main function
main "$@"