#!/bin/bash

# MAUT PANEL PRO EDITION - MAIN MENU
# Owner: @maut_coder
# Powered by MAUT CODER

# Configuration
PANEL_DIR="/opt/maut-panel"
CONFIG_DIR="$PANEL_DIR/config"
SCRIPT_DIR="$PANEL_DIR/scripts"
LOG_DIR="/var/log/maut-panel"
THEME_FILE="$CONFIG_DIR/maut-theme.conf"

# Load theme
load_theme() {
    if [[ -f "$THEME_FILE" ]]; then
        source "$THEME_FILE"
    else
        # Default theme
        COLOR_PRIMARY='\033[0;31m'
        COLOR_SECONDARY='\033[0;33m'
        COLOR_ACCENT='\033[0;36m'
        COLOR_SUCCESS='\033[0;32m'
        COLOR_WARNING='\033[1;33m'
        COLOR_ERROR='\033[0;31m'
        COLOR_INFO='\033[0;34m'
        COLOR_RESET='\033[0m'
    fi
}

# Logging
log_action() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_DIR/maut-actions.log"
}

# System information
get_system_info() {
    CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/" | awk '{print 100 - $1"%"}')
    RAM_USAGE=$(free | grep Mem | awk '{printf "%.2f%", $3/$2 * 100.0}')
    DISK_USAGE=$(df / | grep / | awk '{ print $5 }')
    UPTIME=$(uptime -p | sed 's/up //')
    ONLINE_USERS=$(who | wc -l)
}

# Display banner
show_banner() {
    clear
    echo -e "${COLOR_PRIMARY}"
    echo " ███╗   ███╗ █████╗ ██╗   ██╗████████╗"
    echo " ████╗ ████║██╔══██╗██║   ██║╚══██╔══╝"
    echo " ██╔████╔██║███████║██║   ██║   ██║   "
    echo " ██║╚██╔╝██║██╔══██║██║   ██║   ██║   "
    echo " ██║ ╚═╝ ██║██║  ██║╚██████╔╝   ██║   "
    echo " ╚═╝     ╚═╝╚═╝  ╚═╝ ╚═════╝    ╚═╝   "
    echo -e "${COLOR_ACCENT}"
    echo "        PANEL PRO EDITION v2.1"
    echo "        Powered by MAUT CODER"
    echo -e "${COLOR_RESET}"
    echo "════════════════════════════════════════"
    
    get_system_info
    echo -e "${COLOR_INFO}System Status:${COLOR_RESET}"
    echo -e "  CPU: ${COLOR_SUCCESS}$CPU_USAGE${COLOR_RESET} | RAM: ${COLOR_SUCCESS}$RAM_USAGE${COLOR_RESET}"
    echo -e "  Disk: ${COLOR_SUCCESS}$DISK_USAGE${COLOR_RESET} | Uptime: ${COLOR_SUCCESS}$UPTIME${COLOR_RESET}"
    echo -e "  Online Users: ${COLOR_SUCCESS}$ONLINE_USERS${COLOR_RESET}"
    echo "════════════════════════════════════════"
    echo ""
}

# Main menu
show_menu() {
    echo -e "${COLOR_PRIMARY}MAIN MENU:${COLOR_RESET}"
    echo -e "${COLOR_SUCCESS}01${COLOR_RESET} SSH Menu"
    echo -e "${COLOR_SUCCESS}02${COLOR_RESET} VMESS Menu"
    echo -e "${COLOR_SUCCESS}03${COLOR_RESET} VLESS Menu"
    echo -e "${COLOR_SUCCESS}04${COLOR_RESET} TROJAN Menu"
    echo -e "${COLOR_SUCCESS}05${COLOR_RESET} XRAY Menu"
    echo -e "${COLOR_SUCCESS}06${COLOR_RESET} SHADOWSOCKS"
    echo -e "${COLOR_SUCCESS}07${COLOR_RESET} WebSocket Manager"
    echo -e "${COLOR_SUCCESS}08${COLOR_RESET} Domain & Cloudflare"
    echo -e "${COLOR_SUCCESS}09${COLOR_RESET} Backup & Restore"
    echo -e "${COLOR_SUCCESS}10${COLOR_RESET} System Monitor"
    echo -e "${COLOR_SUCCESS}11${COLOR_RESET} Speedtest"
    echo -e "${COLOR_SUCCESS}12${COLOR_RESET} Network Tools"
    echo -e "${COLOR_SUCCESS}13${COLOR_RESET} Auto Kill Multi Login"
    echo -e "${COLOR_SUCCESS}14${COLOR_RESET} Renew Accounts"
    echo -e "${COLOR_SUCCESS}15${COLOR_RESET} User Activity"
    echo -e "${COLOR_SUCCESS}16${COLOR_RESET} Clear Logs"
    echo -e "${COLOR_SUCCESS}17${COLOR_RESET} Restart Services"
    echo -e "${COLOR_SUCCESS}18${COLOR_RESET} Theme Editor"
    echo -e "${COLOR_SUCCESS}19${COLOR_RESET} Update Script"
    echo -e "${COLOR_SUCCESS}00${COLOR_RESET} Exit"
    echo ""
}

# Menu handlers
handle_ssh_menu() {
    log_action "Accessed SSH Menu"
    "$SCRIPT_DIR/maut-ssh"
}

handle_vmess_menu() {
    log_action "Accessed VMESS Menu"
    "$SCRIPT_DIR/maut-vmess"
}

handle_vless_menu() {
    log_action "Accessed VLESS Menu"
    "$SCRIPT_DIR/maut-vless"
}

handle_trojan_menu() {
    log_action "Accessed TROJAN Menu"
    "$SCRIPT_DIR/maut-trojan"
}

handle_xray_menu() {
    log_action "Accessed XRAY Menu"
    "$SCRIPT_DIR/maut-xray"
}

handle_shadowsocks_menu() {
    log_action "Accessed Shadowsocks Menu"
    "$SCRIPT_DIR/maut-ss"
}

handle_websocket_menu() {
    log_action "Accessed WebSocket Menu"
    "$SCRIPT_DIR/maut-ws"
}

handle_domain_menu() {
    log_action "Accessed Domain & Cloudflare Menu"
    "$SCRIPT_DIR/maut-domain"
}

handle_backup_menu() {
    log_action "Accessed Backup & Restore Menu"
    "$SCRIPT_DIR/maut-backup"
}

handle_monitor_menu() {
    log_action "Accessed System Monitor"
    "$SCRIPT_DIR/maut-monitor"
}

handle_speedtest_menu() {
    log_action "Accessed Speedtest"
    "$SCRIPT_DIR/maut-speedtest"
}

handle_network_tools() {
    log_action "Accessed Network Tools"
    echo -e "${COLOR_INFO}Network Tools Menu${COLOR_RESET}"
    echo "1. Ping Test"
    echo "2. Traceroute"
    echo "3. Netstat"
    echo "4. IP Info"
    echo "5. Back to Main Menu"
    read -p "Select: " choice
    
    case $choice in
        1) read -p "Enter host: " host; ping -c 4 "$host" ;;
        2) read -p "Enter host: " host; traceroute "$host" ;;
        3) netstat -tulpn ;;
        4) curl -s ipinfo.io ;;
        5) return ;;
        *) echo -e "${COLOR_ERROR}Invalid choice${COLOR_RESET}" ;;
    esac
    read -p "Press Enter to continue..."
}

handle_auto_kill() {
    log_action "Accessed Auto Kill Multi Login"
    "$SCRIPT_DIR/maut-helper" kill-multi-login
    read -p "Press Enter to continue..."
}

handle_renew_accounts() {
    log_action "Accessed Renew Accounts"
    echo -e "${COLOR_INFO}Account Renewal${COLOR_RESET}"
    echo "1. Renew SSH"
    echo "2. Renew VMESS"
    echo "3. Renew VLESS"
    echo "4. Renew TROJAN"
    echo "5. Renew All"
    echo "6. Back"
    read -p "Select: " choice
    
    case $choice in
        1) "$SCRIPT_DIR/maut-ssh" renew ;;
        2) "$SCRIPT_DIR/maut-vmess" renew ;;
        3) "$SCRIPT_DIR/maut-vless" renew ;;
        4) "$SCRIPT_DIR/maut-trojan" renew ;;
        5) 
            "$SCRIPT_DIR/maut-ssh" renew
            "$SCRIPT_DIR/maut-vmess" renew
            "$SCRIPT_DIR/maut-vless" renew
            "$SCRIPT_DIR/maut-trojan" renew
            ;;
        6) return ;;
        *) echo -e "${COLOR_ERROR}Invalid choice${COLOR_RESET}" ;;
    esac
    read -p "Press Enter to continue..."
}

handle_user_activity() {
    log_action "Accessed User Activity"
    echo -e "${COLOR_INFO}User Activity Logs${COLOR_RESET}"
    tail -20 "$LOG_DIR/maut-actions.log"
    echo ""
    read -p "Press Enter to continue..."
}

handle_clear_logs() {
    log_action "Cleared all logs"
    echo -e "${COLOR_WARNING}Clearing all logs...${COLOR_RESET}"
    echo "" > "$LOG_DIR/maut-actions.log"
    echo "" > "$LOG_DIR/maut-error.log"
    echo -e "${COLOR_SUCCESS}All logs cleared${COLOR_RESET}"
    read -p "Press Enter to continue..."
}

handle_restart_services() {
    log_action "Restarted all services"
    echo -e "${COLOR_INFO}Restarting services...${COLOR_RESET}"
    systemctl restart xray
    systemctl restart ssh
    systemctl restart nginx 2>/dev/null || true
    systemctl restart apache2 2>/dev/null || true
    echo -e "${COLOR_SUCCESS}All services restarted${COLOR_RESET}"
    read -p "Press Enter to continue..."
}

handle_theme_editor() {
    log_action "Accessed Theme Editor"
    "$SCRIPT_DIR/maut-theme"
}

handle_update_script() {
    log_action "Accessed Update Script"
    "$SCRIPT_DIR/maut-update"
}

# Main loop
main() {
    load_theme
    
    while true; do
        show_banner
        show_menu
        
        read -p "Enter your choice: " choice
        echo ""
        
        case $choice in
            01) handle_ssh_menu ;;
            02) handle_vmess_menu ;;
            03) handle_vless_menu ;;
            04) handle_trojan_menu ;;
            05) handle_xray_menu ;;
            06) handle_shadowsocks_menu ;;
            07) handle_websocket_menu ;;
            08) handle_domain_menu ;;
            09) handle_backup_menu ;;
            10) handle_monitor_menu ;;
            11) handle_speedtest_menu ;;
            12) handle_network_tools ;;
            13) handle_auto_kill ;;
            14) handle_renew_accounts ;;
            15) handle_user_activity ;;
            16) handle_clear_logs ;;
            17) handle_restart_services ;;
            18) handle_theme_editor ;;
            19) handle_update_script ;;
            00) 
                log_action "Exited panel"
                echo -e "${COLOR_SUCCESS}Thank you for using MAUT PANEL PRO!${COLOR_RESET}"
                echo -e "${COLOR_INFO}Owner: @maut_coder${COLOR_RESET}"
                exit 0 
                ;;
            *) 
                echo -e "${COLOR_ERROR}Invalid choice! Please try again.${COLOR_RESET}"
                read -p "Press Enter to continue..."
                ;;
        esac
    done
}

# Start main function
main