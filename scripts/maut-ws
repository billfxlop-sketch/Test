#!/bin/bash

# MAUT PANEL PRO EDITION - WEBSOCKET MANAGER
# Owner: @maut_coder
# Powered by MAUT CODER

# Configuration
PANEL_DIR="/opt/maut-panel"
CONFIG_DIR="$PANEL_DIR/config"
SCRIPT_DIR="$PANEL_DIR/scripts"
LOG_DIR="/var/log/maut-panel"
XRAY_CONFIG="/usr/local/etc/xray/config.json"
NGINX_CONFIG="/etc/nginx/conf.d/maut-websocket.conf"
THEME_FILE="$CONFIG_DIR/maut-theme.conf"

# Load theme
load_theme() {
    if [[ -f "$THEME_FILE" ]]; then
        source "$THEME_FILE"
    else
        COLOR_PRIMARY='\033[0;31m'
        COLOR_SECONDARY='\033[0;33m'
        COLOR_ACCENT='\033[0;36m'
        COLOR_SUCCESS='\033[0;32m'
        COLOR_WARNING='\033[1;33m'
        COLOR_ERROR='\033[0;31m'
        COLOR_INFO='\033[0;34m'
        COLOR_RESET='\033[0m'
    fi
}

# Logging
log_action() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - WEBSOCKET: $1" >> "$LOG_DIR/maut-actions.log"
}

# Check if Nginx is installed
check_nginx() {
    if ! command -v nginx &> /dev/null; then
        echo -e "${COLOR_WARNING}Nginx is not installed. WebSocket features require Nginx.${COLOR_RESET}"
        return 1
    fi
    return 0
}

# Create WebSocket configuration
create_websocket_config() {
    echo -e "${COLOR_INFO}Create WebSocket Configuration${COLOR_RESET}"
    echo ""
    
    if ! check_nginx; then
        echo -e "${COLOR_ERROR}Please install Nginx first${COLOR_RESET}"
        return 1
    fi
    
    read -p "Enter domain name (e.g., example.com): " domain
    if [[ -z "$domain" ]]; then
        echo -e "${COLOR_ERROR}Domain cannot be empty${COLOR_RESET}"
        return 1
    fi
    
    read -p "Enter WebSocket path (e.g., /ws): " ws_path
    ws_path=${ws_path:-/ws}
    
    read -p "Enter backend port (default: 10000): " backend_port
    backend_port=${backend_port:-10000}
    
    # Create Nginx configuration
    create_nginx_ws_config "$domain" "$ws_path" "$backend_port"
    
    # Create Xray configuration for WebSocket
    create_xray_ws_config "$backend_port" "$ws_path"
    
    # Setup SSL if needed
    setup_ssl "$domain"
    
    echo -e "${COLOR_SUCCESS}WebSocket configuration created!${COLOR_RESET}"
    echo -e "${COLOR_INFO}Domain: ${COLOR_SUCCESS}$domain${COLOR_RESET}"
    echo -e "${COLOR_INFO}WebSocket Path: ${COLOR_SUCCESS}$ws_path${COLOR_RESET}"
    echo -e "${COLOR_INFO}Backend Port: ${COLOR_SUCCESS}$backend_port${COLOR_RESET}"
    
    log_action "Created WebSocket config for domain: $domain"
}

# Create Nginx WebSocket configuration
create_nginx_ws_config() {
    local domain="$1"
    local ws_path="$2"
    local backend_port="$3"
    
    cat > "$NGINX_CONFIG" << EOF
# MAUT PANEL PRO - WebSocket Configuration
# Generated on $(date)

server {
    listen 80;
    server_name $domain;
    
    # Redirect to HTTPS
    return 301 https://\$server_name\$request_uri;
}

server {
    listen 443 ssl http2;
    server_name $domain;
    
    ssl_certificate /etc/maut/ssl/cert.pem;
    ssl_certificate_key /etc/maut/ssl/key.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384;
    
    # WebSocket configuration
    location $ws_path {
        proxy_pass http://127.0.0.1:$backend_port;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_read_timeout 86400;
    }
    
    # Additional security headers
    add_header X-Frame-Options DENY always;
    add_header X-Content-Type-Options nosniff always;
    add_header X-XSS-Protection "1; mode=block" always;
}
EOF

    echo -e "${COLOR_SUCCESS}Nginx configuration created: $NGINX_CONFIG${COLOR_RESET}"
    
    # Test Nginx configuration
    if nginx -t &>/dev/null; then
        systemctl reload nginx
        echo -e "${COLOR_SUCCESS}Nginx configuration reloaded${COLOR_RESET}"
    else
        echo -e "${COLOR_ERROR}Nginx configuration test failed${COLOR_RESET}"
        return 1
    fi
}

# Create Xray WebSocket configuration
create_xray_ws_config() {
    local backend_port="$1"
    local ws_path="$2"
    
    # Backup current config
    cp "$XRAY_CONFIG" "$XRAY_CONFIG.backup.$(date +%s)"
    
    echo -e "${COLOR_INFO}Creating Xray WebSocket configuration...${COLOR_RESET}"
    
    # Check if jq is available for JSON manipulation
    if ! command -v jq >/dev/null 2>&1; then
        echo -e "${COLOR_WARNING}jq not available, manual Xray configuration required${COLOR_RESET}"
        return 0
    fi
    
    # Create basic WebSocket inbound if not exists
    if ! jq -e '.inbounds[] | select(.port == '"$backend_port"')' "$XRAY_CONFIG" &>/dev/null; then
        echo -e "${COLOR_INFO}Adding WebSocket inbound on port $backend_port${COLOR_RESET}"
        
        # Create temporary config with new inbound
        jq --argjson port "$backend_port" --arg path "$ws_path" '
        .inbounds += [
            {
                "port": $port,
                "listen": "127.0.0.1",
                "protocol": "vmess",
                "settings": {
                    "clients": []
                },
                "streamSettings": {
                    "network": "ws",
                    "wsSettings": {
                        "path": $path
                    }
                }
            }
        ]' "$XRAY_CONFIG" > "$XRAY_CONFIG.tmp" && mv "$XRAY_CONFIG.tmp" "$XRAY_CONFIG"
        
        if [ $? -eq 0 ]; then
            echo -e "${COLOR_SUCCESS}Xray WebSocket configuration added${COLOR_RESET}"
        else
            echo -e "${COLOR_ERROR}Failed to update Xray configuration${COLOR_RESET}"
            return 1
        fi
    else
        echo -e "${COLOR_INFO}WebSocket inbound already exists on port $backend_port${COLOR_RESET}"
    fi
}

# Setup SSL certificates
setup_ssl() {
    local domain="$1"
    
    echo -e "${COLOR_INFO}Setting up SSL for $domain...${COLOR_RESET}"
    
    # Check if acme.sh is installed
    if [[ -d "/root/.acme.sh" ]]; then
        echo -e "${COLOR_INFO}Using acme.sh for SSL certificate${COLOR_RESET}"
        
        # Create SSL directory
        mkdir -p /etc/maut/ssl
        
        # Issue certificate
        /root/.acme.sh/acme.sh --issue -d "$domain" --standalone --keylength ec-256
        
        if [ $? -eq 0 ]; then
            # Install certificate
            /root/.acme.sh/acme.sh --install-cert -d "$domain" \
                --key-file /etc/maut/ssl/key.pem \
                --fullchain-file /etc/maut/ssl/cert.pem
            
            echo -e "${COLOR_SUCCESS}SSL certificate installed for $domain${COLOR_RESET}"
        else
            echo -e "${COLOR_WARNING}Failed to issue SSL certificate, using self-signed${COLOR_RESET}"
            create_self_signed_cert
        fi
    else
        echo -e "${COLOR_WARNING}acme.sh not found, creating self-signed certificate${COLOR_RESET}"
        create_self_signed_cert
    fi
}

# Create self-signed certificate
create_self_signed_cert() {
    mkdir -p /etc/maut/ssl
    
    openssl req -new -newkey rsa:2048 -days 365 -nodes -x509 \
        -subj "/C=US/ST=State/L=City/O=Organization/CN=localhost" \
        -keyout /etc/maut/ssl/key.pem \
        -out /etc/maut/ssl/cert.pem
    
    echo -e "${COLOR_SUCCESS}Self-signed certificate created${COLOR_RESET}"
}

# List WebSocket configurations
list_websocket_configs() {
    echo -e "${COLOR_INFO}WebSocket Configurations${COLOR_RESET}"
    echo ""
    
    # Check Nginx configurations
    if [[ -f "$NGINX_CONFIG" ]]; then
        echo -e "${COLOR_SUCCESS}Nginx WebSocket Config:${COLOR_RESET}"
        grep -E "server_name|location.*proxy_pass" "$NGINX_CONFIG" | head -10
    else
        echo -e "${COLOR_WARNING}No Nginx WebSocket configuration found${COLOR_RESET}"
    fi
    
    echo ""
    
    # Check Xray WebSocket inbounds
    if [[ -f "$XRAY_CONFIG" ]] && command -v jq >/dev/null 2>&1; then
        echo -e "${COLOR_SUCCESS}Xray WebSocket Inbounds:${COLOR_RESET}"
        jq -r '.inbounds[] | select(.streamSettings.network == "ws") | "Port: \(.port) | Path: \(.streamSettings.wsSettings.path // "none")"' "$XRAY_CONFIG" 2>/dev/null || echo "No WebSocket inbounds found"
    else
        echo -e "${COLOR_INFO}Xray WebSocket configuration check requires jq${COLOR_RESET}"
    fi
}

# Test WebSocket connection
test_websocket_connection() {
    echo -e "${COLOR_INFO}WebSocket Connection Test${COLOR_RESET}"
    echo ""
    
    read -p "Enter domain or IP: " host
    if [[ -z "$host" ]]; then
        echo -e "${COLOR_ERROR}Host cannot be empty${COLOR_RESET}"
        return 1
    fi
    
    read -p "Enter WebSocket path (e.g., /ws): " ws_path
    ws_path=${ws_path:-/ws}
    
    read -p "Enter port (default: 443 for HTTPS, 80 for HTTP): " port
    if [[ -z "$port" ]]; then
        if [[ "$host" == https://* ]] || [[ "$host" == *:443 ]]; then
            port=443
        else
            port=80
        fi
    fi
    
    echo -e "${COLOR_INFO}Testing WebSocket connection to $host:$port$ws_path...${COLOR_RESET}"
    
    # Simple test using curl for WebSocket
    if command -v curl >/dev/null 2>&1; then
        echo -e "${COLOR_INFO}Performing WebSocket handshake test...${COLOR_RESET}"
        
        # Test HTTP/HTTPS connectivity first
        if [[ "$port" -eq 443 ]] || [[ "$host" == https://* ]]; then
            local protocol="https"
        else
            local protocol="http"
        fi
        
        # Remove protocol prefix if present
        local clean_host="${host#https://}"
        clean_host="${clean_host#http://}"
        
        local test_url="$protocol://$clean_host:$port$ws_path"
        
        echo -e "${COLOR_INFO}Testing URL: $test_url${COLOR_RESET}"
        
        # Test basic connectivity
        if curl -s -I --connect-timeout 10 "$test_url" | head -1 | grep -q "HTTP"; then
            echo -e "${COLOR_SUCCESS}✓ Server is reachable${COLOR_RESET}"
        else
            echo -e "${COLOR_ERROR}✗ Server is not reachable${COLOR_RESET}"
        fi
    else
        echo -e "${COLOR_WARNING}curl not available for advanced testing${COLOR_RESET}"
    fi
    
    # Test port connectivity
    if nc -z "$clean_host" "$port" 2>/dev/null; then
        echo -e "${COLOR_SUCCESS}✓ Port $port is open${COLOR_RESET}"
    else
        echo -e "${COLOR_ERROR}✗ Port $port is closed${COLOR_RESET}"
    fi
}

# Remove WebSocket configuration
remove_websocket_config() {
    echo -e "${COLOR_INFO}Remove WebSocket Configuration${COLOR_RESET}"
    echo ""
    
    if [[ ! -f "$NGINX_CONFIG" ]]; then
        echo -e "${COLOR_WARNING}No WebSocket configuration found${COLOR_RESET}"
        return
    fi
    
    echo -e "${COLOR_WARNING}This will remove the WebSocket Nginx configuration${COLOR_RESET}"
    read -p "Are you sure? (y/N): " confirm
    
    if [[ "$confirm" == "y" || "$confirm" == "Y" ]]; then
        rm -f "$NGINX_CONFIG"
        
        # Test and reload Nginx
        if nginx -t &>/dev/null; then
            systemctl reload nginx
            echo -e "${COLOR_SUCCESS}WebSocket configuration removed and Nginx reloaded${COLOR_RESET}"
            log_action "Removed WebSocket configuration"
        else
            echo -e "${COLOR_ERROR}Nginx configuration test failed after removal${COLOR_RESET}"
        fi
    else
        echo "Operation cancelled"
    fi
}

# WebSocket statistics
show_websocket_stats() {
    echo -e "${COLOR_INFO}WebSocket Statistics${COLOR_RESET}"
    echo ""
    
    # Nginx status
    if systemctl is-active --quiet nginx; then
        echo -e "${COLOR_SUCCESS}Nginx: Running${COLOR_RESET}"
        
        # Show active connections
        local connections=$(netstat -tulpn 2>/dev/null | grep :80 | grep -c nginx)
        connections=$((connections + $(netstat -tulpn 2>/dev/null | grep :443 | grep -c nginx)))
        echo -e "Active connections: $connections"
        
        # Show Nginx version
        nginx -v 2>&1 | cut -d'/' -f2
    else
        echo -e "${COLOR_ERROR}Nginx: Not running${COLOR_RESET}"
    fi
    
    echo ""
    
    # Xray WebSocket status
    if systemctl is-active --quiet xray; then
        echo -e "${COLOR_SUCCESS}Xray: Running${COLOR_RESET}"
        
        # Count WebSocket inbounds
        if [[ -f "$XRAY_CONFIG" ]] && command -v jq >/dev/null 2>&1; then
            local ws_count=$(jq '[.inbounds[] | select(.streamSettings.network == "ws")] | length' "$XRAY_CONFIG" 2>/dev/null || echo "0")
            echo -e "WebSocket inbounds: $ws_count"
        fi
    else
        echo -e "${COLOR_ERROR}Xray: Not running${COLOR_RESET}"
    fi
    
    echo ""
    
    # SSL certificate info
    if [[ -f "/etc/maut/ssl/cert.pem" ]]; then
        echo -e "${COLOR_SUCCESS}SSL Certificate:${COLOR_RESET}"
        openssl x509 -in /etc/maut/ssl/cert.pem -noout -subject -dates 2>/dev/null | head -2
    else
        echo -e "${COLOR_WARNING}No SSL certificate found${COLOR_RESET}"
    fi
}

# Install Nginx if not present
install_nginx() {
    echo -e "${COLOR_INFO}Installing Nginx...${COLOR_RESET}"
    
    if command -v apt-get &> /dev/null; then
        apt-get update
        apt-get install -y nginx
    elif command -v yum &> /dev/null; then
        yum install -y nginx
    else
        echo -e "${COLOR_ERROR}Could not determine package manager${COLOR_RESET}"
        return 1
    fi
    
    if systemctl enable nginx && systemctl start nginx; then
        echo -e "${COLOR_SUCCESS}Nginx installed and started${COLOR_RESET}"
        return 0
    else
        echo -e "${COLOR_ERROR}Failed to install Nginx${COLOR_RESET}"
        return 1
    fi
}

# WebSocket menu
show_websocket_menu() {
    clear
    echo -e "${COLOR_PRIMARY}"
    echo " ╔══════════════════════════════════════╗"
    echo " ║         WEBSOCKET MANAGER           ║"
    echo " ║           MAUT PANEL PRO            ║"
    echo " ╚══════════════════════════════════════╝"
    echo -e "${COLOR_RESET}"
    echo -e "${COLOR_INFO}Manage WebSocket configurations and Nginx${COLOR_RESET}"
    echo "════════════════════════════════════════"
    echo ""
    
    # Check Nginx status
    if check_nginx; then
        echo -e "${COLOR_SUCCESS}✓ Nginx is installed${COLOR_RESET}"
    else
        echo -e "${COLOR_WARNING}⚠ Nginx is not installed${COLOR_RESET}"
    fi
    
    echo ""
    
    echo -e "${COLOR_PRIMARY}WEBSOCKET MENU:${COLOR_RESET}"
    echo -e "${COLOR_SUCCESS}01${COLOR_RESET} Create WebSocket Config"
    echo -e "${COLOR_SUCCESS}02${COLOR_RESET} List Configurations"
    echo -e "${COLOR_SUCCESS}03${COLOR_RESET} Test Connection"
    echo -e "${COLOR_SUCCESS}04${COLOR_RESET} Remove Configuration"
    echo -e "${COLOR_SUCCESS}05${COLOR_RESET} Statistics"
    echo -e "${COLOR_SUCCESS}06${COLOR_RESET} Install Nginx"
    echo -e "${COLOR_SUCCESS}07${COLOR_RESET} Nginx Service Control"
    echo -e "${COLOR_SUCCESS}08${COLOR_RESET} Back to Main Menu"
    echo ""
}

# Nginx service control
nginx_service_control() {
    echo -e "${COLOR_INFO}Nginx Service Control${COLOR_RESET}"
    echo ""
    
    if ! check_nginx; then
        echo -e "${COLOR_ERROR}Nginx is not installed${COLOR_RESET}"
        return 1
    fi
    
    echo "1. Start Nginx"
    echo "2. Stop Nginx"
    echo "3. Restart Nginx"
    echo "4. Reload Nginx"
    echo "5. Check Status"
    echo "6. Test Configuration"
    echo "7. Back to Menu"
    
    read -p "Enter your choice: " choice
    
    case $choice in
        1)
            systemctl start nginx
            echo -e "${COLOR_SUCCESS}Nginx started${COLOR_RESET}"
            ;;
        2)
            systemctl stop nginx
            echo -e "${COLOR_WARNING}Nginx stopped${COLOR_RESET}"
            ;;
        3)
            systemctl restart nginx
            echo -e "${COLOR_SUCCESS}Nginx restarted${COLOR_RESET}"
            ;;
        4)
            systemctl reload nginx
            echo -e "${COLOR_SUCCESS}Nginx reloaded${COLOR_RESET}"
            ;;
        5)
            systemctl status nginx --no-pager -l
            ;;
        6)
            nginx -t
            ;;
        7)
            return
            ;;
        *)
            echo -e "${COLOR_ERROR}Invalid choice${COLOR_RESET}"
            ;;
    esac
    
    log_action "Performed Nginx service control: option $choice"
}

# Main WebSocket function
main() {
    load_theme
    
    while true; do
        show_websocket_menu
        
        read -p "Enter your choice: " choice
        echo ""
        
        case $choice in
            01) create_websocket_config ;;
            02) list_websocket_configs ;;
            03) test_websocket_connection ;;
            04) remove_websocket_config ;;
            05) show_websocket_stats ;;
            06) install_nginx ;;
            07) nginx_service_control ;;
            08) 
                log_action "Exited WebSocket Manager"
                break 
                ;;
            *) 
                echo -e "${COLOR_ERROR}Invalid choice! Please try again.${COLOR_RESET}"
                ;;
        esac
        
        echo ""
        read -p "Press Enter to continue..."
    done
}

# Start main function
main "$@"