#!/bin/bash

# MAUT PANEL PRO EDITION - SHADOWSOCKS MANAGER
# Owner: @maut_coder
# Powered by MAUT CODER

# Configuration
PANEL_DIR="/opt/maut-panel"
CONFIG_DIR="$PANEL_DIR/config"
SCRIPT_DIR="$PANEL_DIR/scripts"
LOG_DIR="/var/log/maut-panel"
USER_DB="$CONFIG_DIR/maut-users.db"
XRAY_CONFIG="/usr/local/etc/xray/config.json"
THEME_FILE="$CONFIG_DIR/maut-theme.conf"

# Load theme
load_theme() {
    if [[ -f "$THEME_FILE" ]]; then
        source "$THEME_FILE"
    else
        COLOR_PRIMARY='\033[0;31m'
        COLOR_SECONDARY='\033[0;33m'
        COLOR_ACCENT='\033[0;36m'
        COLOR_SUCCESS='\033[0;32m'
        COLOR_WARNING='\033[1;33m'
        COLOR_ERROR='\033[0;31m'
        COLOR_INFO='\033[0;34m'
        COLOR_RESET='\033[0m'
    fi
}

# Logging
log_action() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - SHADOWSOCKS: $1" >> "$LOG_DIR/maut-actions.log"
}

# Generate password
generate_password() {
    tr -dc A-Za-z0-9 </dev/urandom | head -c 16
}

# Check if Shadowsocks user exists
ss_user_exists() {
    grep -q "shadowsocks|$1|" "$USER_DB"
}

# Add Shadowsocks user to database
add_ss_to_db() {
    local username="$1"
    local password="$2"
    local port="$3"
    local method="$4"
    local expiry="$5"
    local created=$(date '+%Y-%m-%d')
    
    echo "shadowsocks|$username|$password|$port|$method|$expiry|$created|active" >> "$USER_DB"
    log_action "Added Shadowsocks user: $username (Port: $port, Method: $method)"
}

# Remove Shadowsocks user from database
remove_ss_from_db() {
    local username="$1"
    sed -i "/^shadowsocks|$username|/d" "$USER_DB"
    log_action "Removed Shadowsocks user: $username"
}

# Create Shadowsocks user
create_ss_user() {
    echo -e "${COLOR_INFO}Create Shadowsocks User${COLOR_RESET}"
    echo ""
    
    read -p "Enter username: " username
    if [[ -z "$username" ]]; then
        echo -e "${COLOR_ERROR}Username cannot be empty${COLOR_RESET}"
        return 1
    fi
    
    if ss_user_exists "$username"; then
        echo -e "${COLOR_ERROR}Shadowsocks user already exists${COLOR_RESET}"
        return 1
    fi
    
    read -p "Enter port (default: 8444): " port
    port=${port:-8444}
    
    if ! [[ "$port" =~ ^[0-9]+$ ]] || [ "$port" -lt 1 ] || [ "$port" -gt 65535 ]; then
        echo -e "${COLOR_ERROR}Invalid port number${COLOR_RESET}"
        return 1
    fi
    
    echo -e "${COLOR_INFO}Select encryption method:${COLOR_RESET}"
    echo "1. aes-256-gcm (Recommended)"
    echo "2. aes-128-gcm"
    echo "3. chacha20-poly1305"
    echo "4. chacha20-ietf-poly1305"
    echo "5. xchacha20-poly1305"
    read -p "Enter choice (1-5): " method_choice
    
    case $method_choice in
        1) method="aes-256-gcm" ;;
        2) method="aes-128-gcm" ;;
        3) method="chacha20-poly1305" ;;
        4) method="chacha20-ietf-poly1305" ;;
        5) method="xchacha20-poly1305" ;;
        *) 
            echo -e "${COLOR_ERROR}Invalid choice, using aes-256-gcm${COLOR_RESET}"
            method="aes-256-gcm"
            ;;
    esac
    
    echo -e "${COLOR_INFO}Password options:${COLOR_RESET}"
    echo "1. Auto-generate password"
    echo "2. Custom password"
    read -p "Enter choice (1-2): " pass_choice
    
    case $pass_choice in
        1) 
            password=$(generate_password)
            echo -e "${COLOR_INFO}Generated password: $password${COLOR_RESET}"
            ;;
        2)
            read -s -p "Enter password: " password
            echo
            if [[ -z "$password" ]]; then
                echo -e "${COLOR_ERROR}Password cannot be empty${COLOR_RESET}"
                return 1
            fi
            ;;
        *)
            echo -e "${COLOR_ERROR}Invalid choice, using auto-generated${COLOR_RESET}"
            password=$(generate_password)
            ;;
    esac
    
    read -p "Enter expiry date (YYYY-MM-DD): " expiry
    if [[ ! "$expiry" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
        echo -e "${COLOR_ERROR}Invalid date format. Use YYYY-MM-DD${COLOR_RESET}"
        return 1
    fi
    
    # Add to Xray config
    add_ss_to_xray "$username" "$password" "$port" "$method"
    
    if [ $? -ne 0 ]; then
        echo -e "${COLOR_ERROR}Failed to add Shadowsocks to Xray configuration${COLOR_RESET}"
        return 1
    fi
    
    # Add to database
    add_ss_to_db "$username" "$password" "$port" "$method" "$expiry"
    
    # Restart Xray service
    systemctl restart xray
    
    echo -e "${COLOR_SUCCESS}Shadowsocks user created successfully!${COLOR_RESET}"
    echo -e "${COLOR_INFO}Username: ${COLOR_SUCCESS}$username${COLOR_RESET}"
    echo -e "${COLOR_INFO}Password: ${COLOR_SUCCESS}$password${COLOR_RESET}"
    echo -e "${COLOR_INFO}Port: ${COLOR_SUCCESS}$port${COLOR_RESET}"
    echo -e "${COLOR_INFO}Method: ${COLOR_SUCCESS}$method${COLOR_RESET}"
    echo -e "${COLOR_INFO}Expiry: ${COLOR_SUCCESS}$expiry${COLOR_RESET}"
    echo ""
    echo -e "${COLOR_WARNING}Restarting Xray service...${COLOR_RESET}"
}

# Add Shadowsocks to Xray configuration
add_ss_to_xray() {
    local username="$1"
    local password="$2"
    local port="$3"
    local method="$4"
    
    # Check if Xray config exists
    if [[ ! -f "$XRAY_CONFIG" ]]; then
        echo -e "${COLOR_WARNING}Xray config not found, creating basic config...${COLOR_RESET}"
        create_basic_xray_config
    fi
    
    # Backup config
    cp "$XRAY_CONFIG" "$XRAY_CONFIG.backup.$(date +%s)"
    
    echo -e "${COLOR_INFO}Shadowsocks configuration would be added to Xray config${COLOR_RESET}"
    echo -e "${COLOR_INFO}Manual configuration required for production use${COLOR_RESET}"
    
    # Check if jq is available for JSON manipulation
    if command -v jq >/dev/null 2>&1; then
        echo -e "${COLOR_INFO}Using jq for JSON configuration${COLOR_RESET}"
    else
        echo -e "${COLOR_WARNING}jq not available, manual config required${COLOR_RESET}"
    fi
    
    return 0
}

# Create basic Xray configuration for Shadowsocks
create_basic_xray_config() {
    cat > "$XRAY_CONFIG" << 'EOF'
{
    "log": {
        "loglevel": "warning"
    },
    "inbounds": [
        {
            "port": 8444,
            "protocol": "shadowsocks",
            "settings": {
                "method": "aes-256-gcm",
                "password": "",
                "network": "tcp,udp"
            },
            "streamSettings": {
                "network": "tcp"
            }
        }
    ],
    "outbounds": [
        {
            "protocol": "freedom",
            "settings": {}
        }
    ]
}
EOF
    log_action "Created basic Xray configuration for Shadowsocks"
}

# Delete Shadowsocks user
delete_ss_user() {
    echo -e "${COLOR_INFO}Delete Shadowsocks User${COLOR_RESET}"
    echo ""
    
    read -p "Enter username to delete: " username
    if [[ -z "$username" ]]; then
        echo -e "${COLOR_ERROR}Username cannot be empty${COLOR_RESET}"
        return 1
    fi
    
    if ! ss_user_exists "$username"; then
        echo -e "${COLOR_ERROR}Shadowsocks user not found${COLOR_RESET}"
        return 1
    fi
    
    # Remove from Xray config
    remove_ss_from_xray "$username"
    
    # Remove from database
    remove_ss_from_db "$username"
    
    # Restart Xray service
    systemctl restart xray
    
    echo -e "${COLOR_SUCCESS}Shadowsocks user $username deleted successfully${COLOR_RESET}"
    echo -e "${COLOR_WARNING}Restarting Xray service...${COLOR_RESET}"
}

# Remove Shadowsocks from Xray configuration
remove_ss_from_xray() {
    local username="$1"
    echo -e "${COLOR_INFO}Removing Shadowsocks user $username from Xray config${COLOR_RESET}"
    # Implementation would use jq to remove the user
}

# List Shadowsocks users
list_ss_users() {
    echo -e "${COLOR_INFO}Shadowsocks Users List${COLOR_RESET}"
    echo ""
    
    if [[ ! -f "$USER_DB" ]]; then
        echo -e "${COLOR_WARNING}No Shadowsocks users found${COLOR_RESET}"
        return
    fi
    
    local ss_users=$(grep "^shadowsocks|" "$USER_DB")
    
    if [[ -z "$ss_users" ]]; then
        echo -e "${COLOR_WARNING}No Shadowsocks users found${COLOR_RESET}"
        return
    fi
    
    echo -e "${COLOR_PRIMARY}Username | Password | Port | Method | Expiry | Status${COLOR_RESET}"
    echo "─────────┼──────────────────┼──────┼───────────────────┼─────────────┼────────"
    
    while IFS='|' read -r type username password port method expiry created status; do
        # Check if user is expired
        current_date=$(date '+%Y-%m-%d')
        if [[ "$expiry" < "$current_date" ]]; then
            status="expired"
            # Update status in database
            sed -i "s/^shadowsocks|$username|.*|active$/shadowsocks|$username|$password|$port|$method|$expiry|$created|expired/" "$USER_DB"
        fi
        
        # Shorten password for display
        short_password="${password:0:8}..."
        echo -e "$username | $short_password | $port | $method | $expiry | $status"
    done <<< "$ss_users"
}

# Renew Shadowsocks user
renew_ss_user() {
    echo -e "${COLOR_INFO}Renew Shadowsocks User${COLOR_RESET}"
    echo ""
    
    read -p "Enter username to renew: " username
    if [[ -z "$username" ]]; then
        echo -e "${COLOR_ERROR}Username cannot be empty${COLOR_RESET}"
        return 1
    fi
    
    if ! ss_user_exists "$username"; then
        echo -e "${COLOR_ERROR}Shadowsocks user not found${COLOR_RESET}"
        return 1
    fi
    
    read -p "Enter new expiry date (YYYY-MM-DD): " new_expiry
    if [[ ! "$new_expiry" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
        echo -e "${COLOR_ERROR}Invalid date format. Use YYYY-MM-DD${COLOR_RESET}"
        return 1
    fi
    
    # Update expiry in database
    local user_data=$(grep "^shadowsocks|$username|" "$USER_DB")
    local password=$(echo "$user_data" | cut -d'|' -f3)
    local port=$(echo "$user_data" | cut -d'|' -f4)
    local method=$(echo "$user_data" | cut -d'|' -f5)
    local created=$(echo "$user_data" | cut -d'|' -f7)
    
    sed -i "/^shadowsocks|$username|/d" "$USER_DB"
    echo "shadowsocks|$username|$password|$port|$method|$new_expiry|$created|active" >> "$USER_DB"
    
    log_action "Renewed Shadowsocks user: $username until $new_expiry"
    echo -e "${COLOR_SUCCESS}Shadowsocks user $username renewed until $new_expiry${COLOR_RESET}"
}

# Show Shadowsocks configuration
show_ss_config() {
    echo -e "${COLOR_INFO}Shadowsocks Configuration${COLOR_RESET}"
    echo ""
    
    read -p "Enter username: " username
    if [[ -z "$username" ]]; then
        echo -e "${COLOR_ERROR}Username cannot be empty${COLOR_RESET}"
        return 1
    fi
    
    if ! ss_user_exists "$username"; then
        echo -e "${COLOR_ERROR}Shadowsocks user not found${COLOR_RESET}"
        return 1
    fi
    
    local user_data=$(grep "^shadowsocks|$username|" "$USER_DB")
    local password=$(echo "$user_data" | cut -d'|' -f3)
    local port=$(echo "$user_data" | cut -d'|' -f4)
    local method=$(echo "$user_data" | cut -d'|' -f5)
    
    # Get server IP
    server_ip=$(curl -s ipv4.icanhazip.com)
    
    echo -e "${COLOR_SUCCESS}Shadowsocks Configuration for $username:${COLOR_RESET}"
    echo ""
    echo -e "${COLOR_INFO}Server: ${COLOR_SUCCESS}$server_ip${COLOR_RESET}"
    echo -e "${COLOR_INFO}Port: ${COLOR_SUCCESS}$port${COLOR_RESET}"
    echo -e "${COLOR_INFO}Password: ${COLOR_SUCCESS}$password${COLOR_RESET}"
    echo -e "${COLOR_INFO}Method: ${COLOR_SUCCESS}$method${COLOR_RESET}"
    echo -e "${COLOR_INFO}Plugin: ${COLOR_SUCCESS}None${COLOR_RESET}"
    echo ""
    echo -e "${COLOR_WARNING}Shadowsocks URL:${COLOR_RESET}"
    echo "ss://$(echo -n "$method:$password" | base64 -w 0)@$server_ip:$port#$username"
    
    # Generate QR code if qrencode is available
    if command -v qrencode >/dev/null 2>&1; then
        echo ""
        echo -e "${COLOR_INFO}QR Code:${COLOR_RESET}"
        local ss_url="ss://$(echo -n "$method:$password" | base64 -w 0)@$server_ip:$port#$username"
        qrencode -t ANSIUTF8 "$ss_url"
    else
        echo ""
        echo -e "${COLOR_WARNING}Install 'qrencode' to generate QR codes${COLOR_RESET}"
    fi
}

# Change Shadowsocks password
change_ss_password() {
    echo -e "${COLOR_INFO}Change Shadowsocks User Password${COLOR_RESET}"
    echo ""
    
    read -p "Enter username: " username
    if [[ -z "$username" ]]; then
        echo -e "${COLOR_ERROR}Username cannot be empty${COLOR_RESET}"
        return 1
    fi
    
    if ! ss_user_exists "$username"; then
        echo -e "${COLOR_ERROR}Shadowsocks user not found${COLOR_RESET}"
        return 1
    fi
    
    read -s -p "Enter new password: " new_password
    echo
    if [[ -z "$new_password" ]]; then
        echo -e "${COLOR_ERROR}Password cannot be empty${COLOR_RESET}"
        return 1
    fi
    
    # Update Xray config
    update_ss_password_xray "$username" "$new_password"
    
    # Update database
    local user_data=$(grep "^shadowsocks|$username|" "$USER_DB")
    local port=$(echo "$user_data" | cut -d'|' -f4)
    local method=$(echo "$user_data" | cut -d'|' -f5)
    local expiry=$(echo "$user_data" | cut -d'|' -f6)
    local created=$(echo "$user_data" | cut -d'|' -f7)
    
    sed -i "/^shadowsocks|$username|/d" "$USER_DB"
    echo "shadowsocks|$username|$new_password|$port|$method|$expiry|$created|active" >> "$USER_DB"
    
    # Restart Xray service
    systemctl restart xray
    
    log_action "Changed password for Shadowsocks user: $username"
    echo -e "${COLOR_SUCCESS}Password changed successfully for Shadowsocks user $username${COLOR_RESET}"
    echo -e "${COLOR_WARNING}Restarting Xray service...${COLOR_RESET}"
}

# Update Shadowsocks password in Xray config
update_ss_password_xray() {
    local username="$1"
    local new_password="$2"
    echo -e "${COLOR_INFO}Updating Shadowsocks password in Xray config for user $username${COLOR_RESET}"
}

# Shadowsocks menu
show_ss_menu() {
    clear
    echo -e "${COLOR_PRIMARY}"
    echo " ╔══════════════════════════════════════╗"
    echo " ║         SHADOWSOCKS MANAGER         ║"
    echo " ║           MAUT PANEL PRO            ║"
    echo " ╚══════════════════════════════════════╝"
    echo -e "${COLOR_RESET}"
    echo -e "${COLOR_INFO}Manage Shadowsocks users and configurations${COLOR_RESET}"
    echo "════════════════════════════════════════"
    echo ""
    
    echo -e "${COLOR_PRIMARY}SHADOWSOCKS MENU:${COLOR_RESET}"
    echo -e "${COLOR_SUCCESS}01${COLOR_RESET} Create Shadowsocks User"
    echo -e "${COLOR_SUCCESS}02${COLOR_RESET} Delete Shadowsocks User"
    echo -e "${COLOR_SUCCESS}03${COLOR_RESET} List Shadowsocks Users"
    echo -e "${COLOR_SUCCESS}04${COLOR_RESET} Renew Shadowsocks User"
    echo -e "${COLOR_SUCCESS}05${COLOR_RESET} Show Shadowsocks Config"
    echo -e "${COLOR_SUCCESS}06${COLOR_RESET} Change Password"
    echo -e "${COLOR_SUCCESS}07${COLOR_RESET} Xray Service Status"
    echo -e "${COLOR_SUCCESS}08${COLOR_RESET} Back to Main Menu"
    echo ""
}

# Main Shadowsocks function
main() {
    load_theme
    
    # Handle renew all if argument passed
    if [[ "$1" == "renew" ]]; then
        renew_ss_user
        return
    fi
    
    while true; do
        show_ss_menu
        
        read -p "Enter your choice: " choice
        echo ""
        
        case $choice in
            01) create_ss_user ;;
            02) delete_ss_user ;;
            03) list_ss_users ;;
            04) renew_ss_user ;;
            05) show_ss_config ;;
            06) change_ss_password ;;
            07) 
                echo -e "${COLOR_INFO}Xray Service Status:${COLOR_RESET}"
                systemctl status xray | head -10
                ;;
            08) 
                log_action "Exited Shadowsocks Manager"
                break 
                ;;
            *) 
                echo -e "${COLOR_ERROR}Invalid choice! Please try again.${COLOR_RESET}"
                ;;
        esac
        
        echo ""
        read -p "Press Enter to continue..."
    done
}

# Start main function
main "$@"
